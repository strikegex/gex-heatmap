<!DOCTYPE html>
<!-- saved from url=(0048)file:///Users/kevin/Downloads/gex_heatmap_2.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Heatmap + Strategy</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08080d;--panel:#0e0e16;--card:#12121c;--border:#1a1a2a;--text:#b8b8cc;--dim:#555570;--bright:#e8e8f4;--yellow:#fbbf24;--purple:#a855f7;--green:#22c55e;--king:#f59e0b;--accent:#6366f1;--red:#ef4444;--cyan:#06b6d4}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh}

.hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid var(--border);background:var(--panel)}
.hdr h1{font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700;color:var(--bright);letter-spacing:-.5px}
.hdr h1 em{font-style:normal;color:var(--accent)}
.hdr-r{display:flex;gap:10px;align-items:center}
.hdr-r a{font-size:10px;color:var(--accent);text-decoration:none;padding:4px 10px;border:1px solid var(--border);border-radius:4px}
.hdr-r a:hover{background:var(--accent);color:#fff}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--red)}
.status-dot.live{background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-text{font-size:10px;color:var(--dim)}

.ctrl{display:flex;gap:10px;padding:10px 24px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;align-items:center}
button,select{font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--card);color:var(--text);border:1px solid var(--border);padding:5px 10px;border-radius:4px;cursor:pointer;transition:all .15s}
button:hover{background:var(--border);color:var(--bright);border-color:var(--accent)}
.ctrl label{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.ctrl-g{display:flex;align-items:center;gap:6px}

.legend{display:flex;gap:14px;padding:5px 24px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;align-items:center}
.legend-t{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.legend-i{display:flex;align-items:center;gap:4px;font-size:9px}
.lsw{width:11px;height:11px;border-radius:2px;flex-shrink:0}
.lsw.y{background:var(--yellow)}.lsw.p{background:var(--purple)}.lsw.g{background:var(--green)}
.lsw.k{background:linear-gradient(135deg,var(--king),#fde68a);position:relative}
.lsw.k::after{content:"‚òÖ";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:7px;color:#000}
.legend-d{color:var(--dim);font-size:8px}

.sample-banner{display:none;padding:5px 24px;background:rgba(251,191,36,.06);border-bottom:1px solid rgba(251,191,36,.15);font-size:10px;color:var(--yellow);text-align:center}
.sample-banner.vis{display:block}

/* ‚îÄ‚îÄ‚îÄ Rec Cards ‚îÄ‚îÄ‚îÄ */
.rec-wrap{display:none;padding:12px 24px;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.rec-wrap.vis{display:flex}
.rec{flex:1;min-width:280px;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:12px 14px;position:relative;overflow:hidden}
.rec::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.rec.range::before{background:var(--yellow)}.rec.trend::before{background:var(--purple)}.rec.chop::before{background:var(--green)}.rec.bullish::before{background:var(--green)}.rec.bearish::before{background:var(--red)}
.rec-sym{font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:700;color:var(--bright);display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.rec-badge{font-size:8px;padding:2px 6px;border-radius:3px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.rec-badge.range{background:rgba(251,191,36,.12);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.rec-badge.trend{background:rgba(168,85,247,.12);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.rec-badge.chop{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.rec-badge.bullish{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.rec-badge.bearish{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.rec-sum{font-size:11px;color:var(--bright);font-weight:600;line-height:1.5;margin-bottom:6px}
.rec-gamma{font-size:9px;padding:6px 8px;border-radius:4px;margin-bottom:8px;line-height:1.6}
.rec-gamma.neg{background:rgba(168,85,247,.06);border-left:3px solid var(--purple);color:var(--text)}
.rec-gamma.pos{background:rgba(251,191,36,.06);border-left:3px solid var(--yellow);color:var(--text)}
.rec-gamma.neu{background:rgba(34,197,94,.06);border-left:3px solid var(--green);color:var(--text)}
.rec-gamma strong{color:var(--bright)}.rec-gamma .hl{color:var(--king);font-weight:600}
.rec-act{font-size:9px;padding:2px 0;display:flex;align-items:baseline;gap:5px;color:var(--text)}
.rec-lvls{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.rec-lv{font-size:8px;padding:2px 6px;border-radius:3px}
.rec-lv.king{background:rgba(245,158,11,.12);color:var(--king);border:1px solid rgba(245,158,11,.25)}
.rec-lv.rng{background:rgba(99,102,241,.08);color:var(--accent);border:1px solid rgba(99,102,241,.2)}
.rec-lv.gp{background:rgba(168,85,247,.08);color:var(--purple);border:1px solid rgba(168,85,247,.2)}

/* ‚ïê‚ïê‚ïê STRATEGY PANEL ‚ïê‚ïê‚ïê */
.strat-wrap{display:none;padding:12px 24px;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.strat-wrap.vis{display:flex}
.strat-card{flex:1;min-width:280px;max-width:480px;background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.strat-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.strat-sym{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;color:var(--bright)}
.strat-type-badge{font-size:9px;padding:3px 8px;border-radius:4px;font-weight:600;letter-spacing:.3px}
.strat-type-badge.ic{background:rgba(251,191,36,.12);color:var(--yellow);border:1px solid rgba(251,191,36,.25)}
.strat-type-badge.cs{background:rgba(168,85,247,.12);color:var(--purple);border:1px solid rgba(168,85,247,.25)}
.strat-type-badge.bf{background:rgba(6,182,212,.12);color:var(--cyan);border:1px solid rgba(6,182,212,.25)}
.strat-type-badge.ds{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.25)}
.strat-type-badge.dg{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25)}

.strat-body{padding:14px 16px}
.strat-name{font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700;color:var(--bright);margin-bottom:4px}
.strat-rationale{font-size:10px;color:var(--text);line-height:1.7;margin-bottom:12px;padding:8px 10px;background:rgba(255,255,255,.02);border-radius:4px;border-left:3px solid var(--king)}

.strat-legs{margin-bottom:12px}
.strat-legs-title{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.strat-leg{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.02);border-radius:4px;margin-bottom:3px;font-size:11px}
.strat-leg-action{font-weight:700;width:40px;text-align:center;padding:2px 0;border-radius:3px;font-size:9px}
.strat-leg-action.sell{background:rgba(239,68,68,.15);color:var(--red)}
.strat-leg-action.buy{background:rgba(34,197,94,.15);color:var(--green)}
.strat-leg-type{color:var(--dim);width:40px}
.strat-leg-strike{color:var(--bright);font-weight:600;flex:1}
.strat-leg-tag{font-size:8px;padding:1px 5px;border-radius:3px}
.strat-leg-tag.gw{background:rgba(251,191,36,.1);color:var(--yellow)}
.strat-leg-tag.pw{background:rgba(168,85,247,.1);color:var(--purple)}
.strat-leg-tag.kn{background:rgba(245,158,11,.1);color:var(--king)}
.strat-leg-tag.sp{background:rgba(255,255,255,.06);color:var(--dim)}

.strat-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.strat-detail{background:rgba(255,255,255,.02);border-radius:4px;padding:8px 10px;text-align:center}
.strat-detail-label{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.strat-detail-val{font-size:13px;font-weight:600;color:var(--bright)}
.strat-detail-val.profit{color:var(--green)}
.strat-detail-val.risk{color:var(--red)}

.strat-why{font-size:9px;color:var(--dim);line-height:1.6;padding:8px 10px;background:rgba(255,255,255,.015);border-radius:4px;border:1px solid var(--border)}
.strat-why strong{color:var(--text)}
.strat-why em{font-style:normal;color:var(--yellow)}
.strat-why .pur{color:var(--purple)}

.strat-disclaimer{font-size:8px;color:var(--dim);padding:8px 16px;border-top:1px solid var(--border);text-align:center;letter-spacing:.3px}

/* ‚îÄ‚îÄ‚îÄ Heatmap ‚îÄ‚îÄ‚îÄ */
.hm-wrap{display:flex;gap:2px;padding:12px 24px;overflow-x:auto;min-height:calc(100vh - 340px)}
.panel{flex:1;min-width:320px;max-width:600px;background:var(--panel);border:1px solid var(--border);border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
.panel-hdr{display:flex;justify-content:space-between;align-items:baseline;padding:10px 14px 6px;border-bottom:1px solid var(--border)}
.panel-sym{font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:700;color:var(--bright)}
.panel-price{font-size:14px;font-weight:600;color:var(--bright)}
.panel-sub{display:flex;justify-content:space-between;padding:3px 14px 5px;border-bottom:1px solid var(--border)}
.panel-sub span{font-size:9px;color:var(--dim)}
.panel-gp{padding:4px 14px;border-bottom:1px solid var(--border);font-size:10px;display:flex;justify-content:space-between;align-items:center}
.gbadge{padding:2px 6px;border-radius:3px;font-size:8px;font-weight:600}
.gbadge.pos{background:rgba(251,191,36,.12);color:var(--yellow)}.gbadge.neg{background:rgba(168,85,247,.12);color:var(--purple)}.gbadge.neu{background:rgba(34,197,94,.12);color:var(--green)}
.klevels{display:flex;gap:5px;padding:4px 14px 5px;border-bottom:1px solid var(--border);flex-wrap:wrap}
.klev{font-size:7px;padding:2px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.3px}
.klev.gw{background:rgba(251,191,36,.1);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.klev.pw{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.klev.kn{background:rgba(245,158,11,.12);color:var(--king);border:1px solid rgba(245,158,11,.2)}
.klev.sp{background:rgba(255,255,255,.05);color:var(--bright);border:1px solid rgba(255,255,255,.1)}
.strikes{flex:1;overflow-y:auto;padding:2px 0}
.sr{display:flex;align-items:center;height:28px;padding:0 3px;position:relative;cursor:default;transition:background .1s}
.sr:hover{outline:1px solid rgba(255,255,255,.15);z-index:1}
.sr.spot{outline:2px solid #fff;z-index:2}
.sr.king{outline:2px solid var(--king);z-index:3}
.sr-bg{position:absolute;inset:0;opacity:.75;transition:opacity .15s}
.sr:hover .sr-bg{opacity:.9}
.sr-lbl{width:72px;font-size:10px;font-weight:500;text-align:right;padding-right:8px;flex-shrink:0;z-index:1;position:relative;color:var(--text)}
.sr.spot .sr-lbl{color:#fff;font-weight:700}
.sr.spot .sr-lbl::after{content:" ‚ñ∏"}
.sr.king .sr-lbl::before{content:"‚òÖ ";color:var(--king)}
.gbar-c{flex:1;height:100%;position:relative;display:flex;align-items:center;justify-content:flex-end}
.gval{font-size:10px;font-weight:600;position:relative;z-index:1;padding:0 8px;white-space:nowrap;min-width:60px;text-align:right}

.tip{display:none;position:fixed;background:#14142a;border:1px solid var(--border);border-radius:6px;padding:10px 14px;font-size:11px;z-index:100;pointer-events:none;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:240px}
.tip.vis{display:block}
.tip-t{font-weight:600;color:var(--bright);margin-bottom:6px;font-size:12px}
.tip-r{display:flex;justify-content:space-between;gap:14px;margin:3px 0}
.tip-l{color:var(--dim)}.tip-v{color:var(--bright);font-weight:500}
.tip-d{border-top:1px solid var(--border);margin:5px 0}
.tip-b{font-size:9px;color:var(--dim);margin-top:4px;line-height:1.5}
.tip-b strong{color:var(--text)}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh;gap:12px;text-align:center;padding:40px}
.empty h2{font-family:'Space Grotesk',sans-serif;font-size:15px;color:var(--bright)}
.empty p{font-size:12px;color:var(--dim);max-width:440px;line-height:1.7}
.empty code{background:var(--card);padding:2px 6px;border-radius:3px;font-size:10px;color:var(--accent)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>
<div class="hdr">
  <h1><em>GEX</em> Heatmap + Strategy</h1>
  <div class="hdr-r">
    <div class="status-dot live" id="sd"></div><span class="status-text" id="st">Connecting...</span>
  </div>
</div>
<div class="ctrl">
  <div class="ctrl-g localOnly" style="display:none"><button onclick="document.getElementById('fi').click()">üìÇ Load JSON</button><input type="file" id="fi" accept=".json" style="display:none" onchange="loadFile(event)"></div>
  <div class="ctrl-g"><button onclick="loadSample()">üß™ Sample</button></div>
  <div class="ctrl-g"><button onclick="toggleStrats()" id="stratBtn">üìä Strategy ‚ñæ</button></div>
  <div class="ctrl-g"><button onclick="toggleIWM()" id="iwmBtn" style="font-size:10px">IWM: ON</button></div>
  <div class="ctrl-g" style="margin-left:auto"><label>Strikes:</label>
    <select id="ns" onchange="rerender()"><option value="15" selected="">15</option><option value="25">25</option><option value="40">40</option><option value="60">60</option></select>
  </div>
</div>
<div class="legend">
  <span class="legend-t">Heatmap Legend:</span>
  <div class="legend-i"><div class="lsw y"></div><span style="color:var(--yellow)">Yellow (+Gamma)</span></div>
  <div class="legend-i"><div class="lsw p"></div><span style="color:var(--purple)">Purple (‚àíGamma)</span></div>
  <div class="legend-i"><div class="lsw g"></div><span style="color:var(--green)">Green (Neutral)</span></div>
  <div class="legend-i"><div class="lsw k"></div><span style="color:var(--king)">‚òÖ King Node</span></div>
  <button onclick="document.getElementById(&#39;legend-detail&#39;).style.display=document.getElementById(&#39;legend-detail&#39;).style.display===&#39;none&#39;?&#39;block&#39;:&#39;none&#39;" style="margin-left:auto;font-size:9px;padding:3px 8px">? Color Guide</button>
</div>
<div id="legend-detail" style="display:none;padding:14px 24px;border-bottom:1px solid var(--border);background:var(--panel);font-size:10px;line-height:1.8">
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
    <div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--yellow);margin-bottom:6px">üü° Yellow ‚Äî Positive Gamma (+GEX)</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealers are NET SHORT options at this strike. They sold options to customers.</div>
      <div style="color:var(--text);margin-top:4px"><strong>How dealers hedge:</strong> They hedge AGAINST the move. If price rises toward this strike, they sell. If price falls, they buy. This creates <em>mean reversion</em> ‚Äî price snaps back.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Price is "sticky" here. Acts as support (below spot) or resistance (above spot). Volatility dampens. Range-bound action.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚úÖ SELL premium here. Iron condors, credit spreads, butterflies. This is where you want your short strikes ‚Äî dealers defend your position.</div>
    </div>
    <div style="background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--purple);margin-bottom:6px">üü£ Purple ‚Äî Negative Gamma (‚àíGEX)</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealers are NET LONG options at this strike. Customers sold options to dealers.</div>
      <div style="color:var(--text);margin-top:4px"><strong>How dealers hedge:</strong> They hedge WITH the move. If price rises, they buy more. If price falls, they sell more. This creates <em>momentum</em> ‚Äî moves accelerate.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Price is "slippery" here. Breakouts/breakdowns carry through. Volatility expands. Trending/momentum action.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚ö†Ô∏è DO NOT sell premium here. Dealers amplify against you. Instead: buy debit spreads, ride momentum, or stay away. Never place short strikes in purple zones.</div>
    </div>
    <div style="background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--green);margin-bottom:6px">üü¢ Green ‚Äî Neutral / Mixed Gamma</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealer positioning is roughly balanced at this strike. No strong directional bias from hedging flows.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Choppy, indecisive price action. No strong pull in either direction. Low conviction zone.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚ö™ Reduce size. Wait for a clearer setup. If trading, use iron butterflies at king node with smaller position. Can flip +/‚àí without warning.</div>
    </div>
    <div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--king);margin-bottom:6px">‚òÖ King Node ‚Äî Max Absolute Gamma</div>
      <div style="color:var(--text)"><strong>What it means:</strong> The strike with the LARGEST absolute gamma exposure. Where dealers have the most hedging activity.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Acts as a <em>price magnet</em>. Spot drifts toward king throughout the session, especially during 0DTE expiration. Think of it as gravity ‚Äî price wants to pin here.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚òÖ This is your TARGET. Center butterflies here. If king is above spot ‚Üí bullish drift expected. Below ‚Üí bearish drift. At spot ‚Üí pin/chop, perfect for iron condors.</div>
    </div>
  </div>
</div>
<div class="sample-banner" id="sb">‚ö† Sample data</div>

<!-- Recs -->
<div class="rec-wrap" id="rw"></div>

<!-- King/volume tracking is now inside each panel -->

<!-- Strategy (hidden by default) -->
<div class="strat-wrap" id="sw"></div>

<!-- Tooltip -->
<div class="tip" id="tip"><div class="tip-t" id="tt"></div><div id="tb"></div></div>

<!-- Heatmap -->
<div class="hm-wrap" id="hc">
  <div class="empty"><h2>Load GEX Data</h2><p>Click <code>üìÇ Load JSON</code> or <code>üß™ Sample</code></p></div>
</div>

<script>
let D=null;

// ‚ïê‚ïê‚ïê COLOR ‚ïê‚ïê‚ïê
function gc(n,m,k){
  if(k)return{r:245,g:158,b:11,a:.75};
  const r=n/m,a=Math.abs(r);
  if(a<.03)return{r:34,g:160,b:120,a:.25+a*3};
  if(r>0){const t=Math.min(a,1);return{r:Math.round(34+(251-34)*t),g:Math.round(160+(191-160)*t),b:Math.round(120+(36-120)*t),a:.22+t*.55}}
  const t=Math.min(a,1);return{r:Math.round(34+(130-34)*t),g:Math.round(160+(60-160)*t),b:Math.round(120+(220-120)*t),a:.22+t*.55};
}
function tc(n,m,k){if(k)return'#fde68a';const r=n/m;if(Math.abs(r)<.03)return'#86efac';return r>0?'#fde68a':'#d8b4fe'}
function ct(n,m){const r=n/m;return Math.abs(r)<.08?'neutral':r>0?'positive':'negative'}
function bh(c,k){if(k)return'<strong>‚òÖ King</strong> ‚Äî Max Gamma ¬∑ Price Magnet';if(c==='positive')return'<strong>+Gamma</strong> ‚Äî Dealers Short ¬∑ Mean Reversion';if(c==='negative')return'<strong>‚àíGamma</strong> ‚Äî Dealers Long ¬∑ Momentum';return'<strong>Neutral</strong> ‚Äî Choppy'}
function fg(v){const a=Math.abs(v);const s=v<0?'-':'';if(a>=1e9)return s+'$'+(a/1e9).toFixed(1)+'B';if(a>=1e6)return s+'$'+(a/1e6).toFixed(1)+'M';if(a>=1e3)return s+'$'+(a/1e3).toFixed(1)+'K';return s+'$'+a.toFixed(0)}
function fp(p){return p>=1000?p.toFixed(0):p.toFixed(2)}

// ‚ïê‚ïê‚ïê STRATEGY ENGINE ‚Äî 0DTE Conservative (tastylive research) ‚ïê‚ïê‚ïê
// 0DTE IC rules: 5-15Œî shorts, $25-30 wings, stop = total credit per side
// Source: tastylive 0DTE research, ThetaProfits breakeven IC, OptionAlpha backtests
function generateStrategy(d) {
  const {symbol, spot, strikes, total_net_gex} = d;
  if (!strikes || !strikes.length) return null;

  const mx = Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  const king = strikes.reduce((b,s)=>(s.total_gamma||0)>(b.total_gamma||0)?s:b);
  const gw = strikes.reduce((b,s)=>s.net_gex>b.net_gex?s:b);
  const pw = strikes.reduce((b,s)=>s.net_gex<b.net_gex?s:b);
  const posAbove = strikes.filter(s=>s.strike>spot&&s.net_gex>mx*.12).sort((a,b)=>a.strike-b.strike);
  const posBelow = strikes.filter(s=>s.strike<spot&&s.net_gex>mx*.12).sort((a,b)=>b.strike-a.strike);
  const profile = total_net_gex>mx*.1?'positive':total_net_gex<-mx*.1?'negative':'neutral';
  const kd = king.strike-spot, kdPct=(kd/spot)*100;

  const sorted = [...strikes].sort((a,b)=>a.strike-b.strike);
  const step = sorted.length>=2 ? sorted[1].strike-sorted[0].strike : 5;
  const rnd = v => Math.round(v/step)*step;

  // 0DTE WINGS: $25 for SPX, $5 for ETFs (proportional to underlying)
  const WING = symbol==='SPX' ? 25 : 5;

  // 0DTE DELTA: 10Œî shorts (conservative, 5-15Œî range)
  // SPX 10Œî ~= 30-40pts OTM, ETFs 10Œî ~= 0.6-0.8% OTM
  function getDeltaStrike(direction, targetDelta) {
    const spxPts = {0.05:50, 0.08:38, 0.10:30, 0.12:25, 0.15:20};
    const etfPct = {0.05:0.010, 0.08:0.007, 0.10:0.006, 0.12:0.005, 0.15:0.004};
    let offset = symbol==='SPX' ? (spxPts[targetDelta]||30) : spot*(etfPct[targetDelta]||0.006);
    return rnd(direction==='call' ? spot+offset : spot-offset);
  }

  function gexValidate(strike, direction) {
    const nearest = sorted.reduce((b,s)=>Math.abs(s.strike-strike)<Math.abs(b.strike-strike)?s:b);
    const gexR = nearest.net_gex/mx;
    let tag='',tagCls='sp',conf='STANDARD',adj=strike;
    if(gexR>.15){tag='+Gamma Wall';tagCls='gw';conf='HIGH';adj=nearest.strike}
    else if(gexR<-.15){
      const cands=direction==='put'?sorted.filter(s=>s.strike<spot&&s.net_gex>mx*.10).sort((a,b)=>b.strike-a.strike):sorted.filter(s=>s.strike>spot&&s.net_gex>mx*.10).sort((a,b)=>a.strike-b.strike);
      if(cands.length){adj=cands[0].strike;tag='+Gamma (shifted)';tagCls='gw';conf='HIGH (adj)'}
      else{tag='‚ö† ‚àíGamma';tagCls='pw';conf='LOW'}
    }else{tag=`~${(Math.abs(strike-spot)/spot*100).toFixed(2)}% OTM`}
    if(Math.abs(adj-king.strike)<=step){tag+=' (‚òÖ King)';tagCls='kn'}
    return{strike:adj,tag,tagCls,conf,orig:strike};
  }

  function estPrem(strike, type) {
    const s=sorted.reduce((b,c)=>Math.abs(c.strike-strike)<Math.abs(b.strike-strike)?c:b);
    const bid=type==='call'?(s.call_bid||0):(s.put_bid||0);
    const ask=type==='call'?(s.call_ask||0):(s.put_ask||0);
    if(bid>0&&ask>0)return `$${bid.toFixed(2)}‚Äì$${ask.toFixed(2)}`;
    if(ask>0)return `~$${ask.toFixed(2)}`;
    return null;
  }

  function driftComm() {
    const dist=Math.abs(kd).toFixed(1),dir=kd>0?'above':'below',pct=Math.abs(kdPct).toFixed(2);
    let c=`<strong>‚òÖ King ${fp(king.strike)}</strong> ‚Äî ${dist}pts ${dir} (${pct}%). `;
    if(Math.abs(kdPct)<.05) c+=`ON the king. <em>Strong pin.</em> Ideal for ICs.`;
    else if(Math.abs(kdPct)<.15) c+=kd>0?`Slight upward pull. <em>Buy dips, sell at king.</em>`:`Slight downward pull. <em>Sell rips, cover at king.</em>`;
    else c+=kd>0?`Strong upward gravity. <em>Bullish ‚Äî buy calls targeting king.</em>`:`Strong downward gravity. <em>Bearish ‚Äî buy puts targeting king.</em>`;
    if(posAbove[0]&&posBelow[0]) c+=` Range: ${fp(posBelow[0].strike)}‚Äì${fp(posAbove[0].strike)}.`;
    return c;
  }

  let strategies = [];

  // ‚ïê‚ïê‚ïê +GAMMA ‚Üí SELL PREMIUM (CONSERVATIVE 0DTE) ‚ïê‚ïê‚ïê
  if (profile === 'positive') {
    // 10Œî shorts ‚Äî ~30pts OTM for SPX, much wider than old 16Œî
    const rawSP = getDeltaStrike('put', 0.10);
    const rawSC = getDeltaStrike('call', 0.10);
    const valP = gexValidate(rawSP,'put'), valC = gexValidate(rawSC,'call');
    const sp = valP.strike, sc = valC.strike;
    const lp = sp-WING, lc = sc+WING;

    // Premium estimate from live data
    const sPutN = sorted.reduce((b,c)=>Math.abs(c.strike-sp)<Math.abs(b.strike-sp)?c:b);
    const sCallN = sorted.reduce((b,c)=>Math.abs(c.strike-sc)<Math.abs(b.strike-sc)?c:b);
    const lpN = sorted.reduce((b,c)=>Math.abs(c.strike-lp)<Math.abs(b.strike-lp)?c:b);
    const lcN = sorted.reduce((b,c)=>Math.abs(c.strike-lc)<Math.abs(b.strike-lc)?c:b);
    const pCr = ((sPutN.put_bid||0)+(sPutN.put_ask||0))/2-((lpN.put_bid||0)+(lpN.put_ask||0))/2;
    const cCr = ((sCallN.call_bid||0)+(sCallN.call_ask||0))/2-((lcN.call_bid||0)+(lcN.call_ask||0))/2;
    const totCr = pCr+cCr;
    const premEst = totCr>.10?`~$${totCr.toFixed(2)}/ct ($${(totCr*100).toFixed(0)} per IC)`:`Target ‚Öì of $${WING} wing`;

    strategies.push({
      name:'Iron Condor (0DTE)',type:'ic',
      rationale:`<strong>Conservative 0DTE:</strong> 10Œî shorts (~${symbol==='SPX'?'30pts':'0.6%'} OTM), $${WING} wings. +Gamma = dealers dampen vol. <em>5-15Œî short range per tastylive/ThetaProfits research.</em>`,
      legs:[
        {action:'BUY',type:'PUT',strike:lp,tag:`Wing ($${WING})`,tagCls:'sp'},
        {action:'SELL',type:'PUT',strike:sp,tag:valP.tag,tagCls:valP.tagCls,note:sp!==valP.orig?`(shifted from ${fp(valP.orig)})`:'(~10Œî)'},
        {action:'SELL',type:'CALL',strike:sc,tag:valC.tag,tagCls:valC.tagCls,note:sc!==valC.orig?`(shifted from ${fp(valC.orig)})`:'(~10Œî)'},
        {action:'BUY',type:'CALL',strike:lc,tag:`Wing ($${WING})`,tagCls:'sp'},
      ],
      expectedPremium:premEst,
      maxProfit:totCr>.10?`$${(totCr*100).toFixed(0)}`:'Credit received',
      maxRisk:totCr>.10?`$${((WING-totCr)*100).toFixed(0)}`:`$${WING*100} minus credit`,
      target:`Stay between ${fp(sp)} ‚Äì ${fp(sc)}`,
      why:[
        driftComm(),
        `<strong>Why 10Œî not 16Œî:</strong> 0DTE gamma is extreme. 16Œî is too close ‚Äî a 1% move breaches your short. 10Œî gives ~90% POP per side, ~80% combined. This is the tastylive/ThetaProfits standard for 0DTE.`,
        `<strong>$${WING} wings:</strong> Wider than 45DTE ICs because 0DTE gamma spikes can blow through narrow wings. $${WING} gives room to manage.`,
        `<strong>Stop:</strong> Each side separately = total IC credit. If one side stops, the other likely profits (breakeven IC). Close by 3:45pm.`,
        `<strong>Entry:</strong> Best after 10:30am ET. Avoid first 30min (opening volatility). Equal credit both sides if possible.`,
      ],
    });

    // Sell Put at +gamma support
    if(kd>=0&&posBelow[0]){
      const nk=posBelow[0].strike, nkP=estPrem(nk,'put');
      strategies.push({name:'Sell Put (Support)',type:'cs',
        rationale:`+Gamma support at ${fp(nk)}. Dealers defend this floor.`,
        legs:[{action:'SELL',type:'PUT',strike:nk,tag:'+Gamma Wall',tagCls:'gw',note:'(~15-20Œî)'}],
        expectedPremium:nkP||'Check chain',maxProfit:'Credit',maxRisk:`Assignment at ${fp(nk)}`,target:`Above ${fp(nk)}`,
        why:[driftComm(),`Close at 50% profit. Roll if delta hits 40.`],
      });
    }

    // Buy ATM Call if king above
    if(kd>spot*.001){
      const cs=rnd(spot),cP=estPrem(cs,'call');
      strategies.push({name:'Buy Call (Drift)',type:'ds',
        rationale:`King above = upward magnet. +Gamma = controlled drift. ATM call captures move.`,
        legs:[{action:'BUY',type:'CALL',strike:cs,tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium:cP?`Cost: ${cP}`:'Check chain',maxProfit:'Unlimited',maxRisk:'Premium paid',target:`Rally to ${fp(king.strike)}`,
        why:[driftComm(),`Take profit 50-100%. Cut at 50% loss. Best entered AM.`],
      });
    }

    // Butterfly pin play
    if(Math.abs(kdPct)<.2){
      const ctr=rnd(king.strike);
      strategies.push({name:'Butterfly (Pin)',type:'bf',
        rationale:`King near spot + +gamma = pin probability. Lottery ticket after 2pm.`,
        legs:[
          {action:'BUY',type:'CALL',strike:ctr-WING,tag:'Lower',tagCls:'sp'},
          {action:'SELL',type:'CALL',strike:ctr,tag:'‚òÖ King',tagCls:'kn',qty:2},
          {action:'BUY',type:'CALL',strike:ctr+WING,tag:'Upper',tagCls:'sp'},
        ],
        expectedPremium:'~$1-$3 debit',maxProfit:`$${WING*100} minus debit`,maxRisk:'Debit paid',target:`Pin ${fp(ctr)}`,
        why:[`Enter after 2pm. Small size ‚Äî lottery ticket.`],
      });
    }
  }

  // ‚ïê‚ïê‚ïê ‚àíGAMMA ‚Üí DIRECTIONAL ‚ïê‚ïê‚ïê
  else if (profile === 'negative') {
    if(kd>0){
      const lc=rnd(spot),scK=rnd(Math.min(king.strike,spot+step*6)),lP=estPrem(lc,'call');
      strategies.push({name:'Call Debit Spread',type:'ds',
        rationale:`‚àíGamma + king above = dealers amplify upward moves. Buy direction.`,
        legs:[{action:'BUY',type:'CALL',strike:lc,tag:'ATM',tagCls:'sp',note:'(~50Œî)'},{action:'SELL',type:'CALL',strike:scK,tag:'Near king',tagCls:'kn'}],
        expectedPremium:lP?`ATM: ${lP}`:'Verify',maxProfit:`$${(scK-lc)*100}`,maxRisk:'Debit',target:`Rally to ${fp(king.strike)}`,
        why:[driftComm(),`<span class="pur">‚àíGamma = DON'T sell ICs here.</span> Buy direction.`,`Take profit 50-75%. Cut at 50% debit loss.`],
      });
      const cP2=estPrem(rnd(spot),'call');
      strategies.push({name:'Buy Call (Momentum)',type:'ds',
        rationale:`‚àíGamma amplifies. King above. Naked call for max upside.`,
        legs:[{action:'BUY',type:'CALL',strike:rnd(spot),tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium:cP2?`Cost: ${cP2}`:'Check chain',maxProfit:'Unlimited',maxRisk:'Premium',target:`${fp(king.strike)}+`,
        why:[driftComm(),`Trail stop at 50% gains.`],
      });
    }else if(kd<0){
      const lpS=rnd(spot),spK=rnd(Math.max(king.strike,spot-step*6)),lP=estPrem(lpS,'put');
      strategies.push({name:'Put Debit Spread',type:'ds',
        rationale:`‚àíGamma + king below = dealers amplify down. Buy direction.`,
        legs:[{action:'BUY',type:'PUT',strike:lpS,tag:'ATM',tagCls:'sp',note:'(~50Œî)'},{action:'SELL',type:'PUT',strike:spK,tag:'Near king',tagCls:'kn'}],
        expectedPremium:lP?`ATM: ${lP}`:'Verify',maxProfit:`$${(lpS-spK)*100}`,maxRisk:'Debit',target:`Drop to ${fp(king.strike)}`,
        why:[driftComm(),`Take profit 50-75%. Cut at 50% debit loss.`],
      });
      const pP=estPrem(rnd(spot),'put');
      strategies.push({name:'Buy Put (Momentum)',type:'ds',
        rationale:`‚àíGamma + king below. Naked put for max downside.`,
        legs:[{action:'BUY',type:'PUT',strike:rnd(spot),tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium:pP?`Cost: ${pP}`:'Check chain',maxProfit:'Substantial',maxRisk:'Premium',target:`${fp(king.strike)}+`,
        why:[driftComm(),`Trail stop at 50% gains.`],
      });
    }
  }

  // ‚ïê‚ïê‚ïê NEUTRAL ‚ïê‚ïê‚ïê
  else {
    const ctr=rnd(king.strike);
    strategies.push({name:'Iron Butterfly (¬Ω Size)',type:'bf',
      rationale:`Neutral. King at ${fp(ctr)} weak magnet. Half size, tight stops.`,
      legs:[
        {action:'BUY',type:'PUT',strike:ctr-WING,tag:'Put wing',tagCls:'sp'},
        {action:'SELL',type:'PUT',strike:ctr,tag:'‚òÖ King',tagCls:'kn'},
        {action:'SELL',type:'CALL',strike:ctr,tag:'‚òÖ King',tagCls:'kn'},
        {action:'BUY',type:'CALL',strike:ctr+WING,tag:'Call wing',tagCls:'sp'},
      ],
      expectedPremium:'Check chain (ATM)',maxProfit:'Credit',maxRisk:`$${WING*100} minus credit`,target:`Pin ${fp(ctr)}`,
      why:[driftComm(),`25% profit target. Stop at 1√ó credit. Half size.`],
    });
  }

  return strategies;
}

// ‚ïê‚ïê‚ïê KING HISTORY + VOLUME SURGE ‚Äî per-panel (not global bar) ‚ïê‚ïê‚ïê
function getTrackingHtml(sym) {
  if (!D || !D[sym]) return '';
  const d = D[sym];
  let html = '';

  // King history
  const kh = d.king_history || [];
  if (kh.length >= 2) {
    const first = kh[0], last = kh[kh.length-1];
    const mins = Math.round((new Date(last.timestamp)-new Date(first.timestamp))/60000);
    const hrs = mins >= 60 ? `${Math.floor(mins/60)}h${mins%60}m` : `${mins}m`;
    const delta = last.strike - first.strike;
    const dir = delta>0?'‚Üë':delta<0?'‚Üì':'‚Üí';
    html += `<div style="padding:2px 14px;font-size:8px;color:var(--king);border-bottom:1px solid var(--border)">‚òÖ King: ${fp(first.strike)} ‚Üí ${fp(last.strike)} (${delta>0?'+':''}${delta.toFixed(0)}pts ${dir}) ${hrs}`;
    if (kh.length > 2) html += ` ¬∑ ${kh.map(k=>fp(k.strike)).join('‚Üí')}`;
    html += `</div>`;
  }

  // Volume surges
  const vs = d.volume_surges || [];
  if (vs.length > 0) {
    html += `<div style="padding:2px 14px;font-size:8px;color:var(--cyan);border-bottom:1px solid var(--border)">üìà `;
    html += vs.slice(0,3).map(v=>
      `${fp(v.strike)} +${v.delta.toLocaleString()} (${v.pct>0?'+':''}${v.pct}%)`
    ).join(' ¬∑ ');
    html += `</div>`;
  }

  return html;
}

// ‚ïê‚ïê‚ïê STRATEGY TOGGLE ‚ïê‚ïê‚ïê
let stratVisible = false;
function toggleStrats() {
  stratVisible = !stratVisible;
  const sw = document.getElementById('sw'), btn = document.getElementById('stratBtn');
  if (stratVisible) { sw.classList.add('vis'); btn.textContent='üìä Strategy ‚ñ¥'; renderStrats(); }
  else { sw.classList.remove('vis'); btn.textContent='üìä Strategy ‚ñæ'; }
}

function renderStrats() {
  const sw = document.getElementById('sw');
  if (!D||!stratVisible) { sw.classList.remove('vis'); sw.innerHTML=''; return; }
  sw.innerHTML=''; sw.classList.add('vis');

  const syms = Object.keys(D).sort((a,b)=>a==='SPX'?-1:b==='SPX'?1:0);
  syms.forEach(sym => {
    const sd = D[sym]; if(!sd) return;
    const strats = generateStrategy(sd);
    if (!strats||!strats.length) return;
    const s = strats[0];
    const card = document.createElement('div'); card.className='strat-card';
    const legsH = s.legs.map(l=>`<div class="strat-leg"><span class="strat-leg-action ${l.action.toLowerCase()}">${l.action}</span><span class="strat-leg-type">${l.type}</span><span class="strat-leg-strike">${fp(l.strike)}${l.qty?' √ó'+l.qty:''}${l.note?' <span style="color:var(--dim);font-size:9px">'+l.note+'</span>':''}</span><span class="strat-leg-tag ${l.tagCls}">${l.tag}</span></div>`).join('');
    const whyH = s.why.map(w=>`<div style="margin:4px 0">‚Üí ${w}</div>`).join('');
    const altH = strats.length>1?'<div style="padding:8px 16px;border-top:1px solid var(--border);font-size:9px;color:var(--dim)"><strong style="color:var(--text)">Alt:</strong> '+strats.slice(1).map(a=>`<span style="margin-left:6px;padding:2px 6px;background:rgba(255,255,255,.03);border-radius:3px">${a.name}</span>`).join('')+'</div>':'';
    card.innerHTML=`<div class="strat-hdr"><span class="strat-sym">${sym} ¬∑ $${fp(sd.spot)}</span><span class="strat-type-badge ${s.type}">${s.name}</span></div><div class="strat-body"><div class="strat-rationale">${s.rationale}</div><div class="strat-legs"><div class="strat-legs-title">Legs</div>${legsH}</div><div class="strat-details"><div class="strat-detail"><div class="strat-detail-label">Premium</div><div class="strat-detail-val" style="color:var(--cyan);font-size:10px">${s.expectedPremium||'‚Äî'}</div></div><div class="strat-detail"><div class="strat-detail-label">Max Profit</div><div class="strat-detail-val profit">${s.maxProfit}</div></div><div class="strat-detail"><div class="strat-detail-label">Max Risk</div><div class="strat-detail-val risk">${s.maxRisk}</div></div><div class="strat-detail"><div class="strat-detail-label">Target</div><div class="strat-detail-val">${s.target}</div></div></div><div class="strat-why">${whyH}</div></div>${altH}<div class="strat-disclaimer">‚ö† Not financial advice. Verify on live chain.</div>`;
    sw.appendChild(card);
  });

  // Confluence
  if(syms.length>=3){
    const profs=syms.map(s=>{const d=D[s];const m=Math.max(...d.strikes.map(x=>Math.abs(x.net_gex)),1);return d.total_net_gex>m*.1?'pos':d.total_net_gex<-m*.1?'neg':'neu'});
    const all=profs.every(p=>p===profs[0]);
    const cc=document.createElement('div');cc.style.cssText='width:100%;padding:8px 12px;border-radius:6px;font-size:10px;margin-top:4px';
    if(all){cc.style.background='rgba(34,197,94,.08)';cc.style.color='var(--green)';cc.innerHTML=`‚úÖ <strong>Full confluence</strong> ‚Äî All ${profs[0]==='pos'?'+gamma':profs[0]==='neg'?'‚àígamma':'neutral'}.`}
    else{cc.style.background='rgba(251,191,36,.08)';cc.style.color='var(--yellow)';cc.innerHTML=`‚ö† <strong>Mixed signals</strong> ‚Äî Reduce size.`}
    sw.appendChild(cc);
  }
}

// ‚îÄ‚îÄ‚îÄ Recs ‚îÄ‚îÄ‚îÄ
function genRec(d){
  const{spot,strikes,total_net_gex}=d;if(!strikes||!strikes.length)return{summary:'No data',bias:'neutral',action_items:[]};
  const mx=Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  const king=strikes.reduce((b,s)=>(s.total_gamma||0)>(b.total_gamma||0)?s:b);
  const posA=strikes.filter(s=>s.strike>spot&&s.net_gex>mx*.15).sort((a,b)=>a.strike-b.strike);
  const posB=strikes.filter(s=>s.strike<spot&&s.net_gex>mx*.15).sort((a,b)=>b.strike-a.strike);
  const profile=total_net_gex>mx*.1?'positive':total_net_gex<-mx*.1?'negative':'neutral';
  const bias=profile==='positive'?'range':profile==='negative'?'trend':'chop';
  const kd=king.strike-spot;
  const items=[];
  if(Math.abs(kd/spot*100)>.02)items.push(`DRIFT: ${king.strike.toFixed(1)} (${kd>0?'above':'below'})`);
  else items.push(`PIN: ${king.strike.toFixed(1)}`);
  if(posB[0])items.push(`SUPPORT: ${posB[0].strike.toFixed(1)}`);
  if(posA[0])items.push(`RESISTANCE: ${posA[0].strike.toFixed(1)}`);
  const hi=posA[0]?.strike||(kd>0?king.strike:spot+20),lo=posB[0]?.strike||(kd<0?king.strike:spot-20);
  let summary;
  if(profile==='positive'&&Math.abs(kd/spot*100)<.15)summary=`PIN & CHOP ‚Äî King ${king.strike.toFixed(1)}. Fade ${lo.toFixed(1)}‚Äì${hi.toFixed(1)}.`;
  else if(profile==='positive')summary=`DRIFT TO KING ‚Äî Magnet ${king.strike.toFixed(1)}.`;
  else if(profile==='negative'&&kd>0)summary=`BULLISH MOMENTUM ‚Äî King UP to ${king.strike.toFixed(1)}.`;
  else if(profile==='negative'&&kd<0)summary=`BEARISH MOMENTUM ‚Äî King DOWN to ${king.strike.toFixed(1)}.`;
  else summary=`CHOPPY ‚Äî King ${king.strike.toFixed(1)}.`;
  return{summary,bias,king_node:{strike:king.strike},expected_range:{low:lo,high:hi},action_items:items};
}

function renderRecs(){
  const rw=document.getElementById('rw');if(!D){rw.classList.remove('vis');return}
  rw.innerHTML='';rw.classList.add('vis');
  getVisibleSyms().forEach(sym=>{
    const d=D[sym],r=d.recommendation||genRec(d);
    const spot=d.spot, strikes=d.strikes||[];
    const sorted=[...strikes].sort((a,b)=>a.strike-b.strike);
    const mx=Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
    const king=strikes.reduce((b,s)=>(s.total_gamma||Math.abs(s.net_gex))>(b.total_gamma||Math.abs(b.net_gex))?s:b,strikes[0]);
    const kingD=king?king.strike-spot:0;
    const kingPct=spot?((kingD/spot)*100).toFixed(2):0;
    const gw=d.gamma_wall||0, pw=d.put_wall||0;
    const net=d.total_net_gex||0;

    // Gamma profile
    const isNeg=net<-mx*.05, isPos=net>mx*.05;
    const gpClass=isNeg?'neg':isPos?'pos':'neu';
    const gpLabel=isNeg?'‚àíGamma (Momentum)':isPos?'+Gamma (Mean Revert)':'Neutral (Choppy)';

    // Bias
    const bias=r.bias||'chop';

    // Build rich commentary
    let commentary='';
    if(isNeg && kingD>0){
      commentary=`<strong>‚àíGamma + King above</strong> = dealers amplify upward moves. Expect <span class="hl">bullish momentum toward ${fp(king.strike)}</span>. Buy dips, don't fade. Debit call spreads favored.`;
    } else if(isNeg && kingD<0){
      commentary=`<strong>‚àíGamma + King below</strong> = dealers amplify downward moves. Expect <span class="hl">bearish momentum toward ${fp(king.strike)}</span>. Sell rips, buy put spreads. Do NOT sell premium here.`;
    } else if(isNeg && Math.abs(kingD)<spot*.001){
      commentary=`<strong>‚àíGamma + King at spot</strong> = explosive either direction. <span class="hl">Wait for break</span>, then ride momentum. Straddles or strangles if IV is low.`;
    } else if(isPos && Math.abs(kingD)<spot*.002){
      commentary=`<strong>+Gamma + King at spot</strong> = <span class="hl">pin & chop</span>. Dealers suppress moves both ways. Sell premium: iron condors, butterflies centered on ${fp(king.strike)}.`;
    } else if(isPos && kingD>0){
      commentary=`<strong>+Gamma + King above</strong> = slow grind up toward <span class="hl">${fp(king.strike)}</span>. Dealers dampen selloffs. Sell put spreads below, or drift-to-king butterflies.`;
    } else if(isPos && kingD<0){
      commentary=`<strong>+Gamma + King below</strong> = slow grind down toward <span class="hl">${fp(king.strike)}</span>. Dealers dampen rallies. Sell call spreads above, or drift-to-king butterflies.`;
    } else {
      commentary=`<strong>Mixed gamma</strong> ‚Äî no strong dealer bias. <span class="hl">Reduce size</span>, wait for clearer setup. King at ${fp(king?king.strike:0)}.`;
    }

    // Directional line
    const dirLine = kingD>0 
      ? `‚òÖ King ${fp(king.strike)} ‚Äî ${Math.abs(kingD).toFixed(1)}pts <span style="color:var(--green)">above</span> spot (${kingPct}%). Drift target ‚Üë`
      : kingD<0
      ? `‚òÖ King ${fp(king.strike)} ‚Äî ${Math.abs(kingD).toFixed(1)}pts <span style="color:var(--red)">below</span> spot (${kingPct}%). Drift target ‚Üì`
      : `‚òÖ King ${fp(king.strike)} ‚Äî AT spot. Pin expected.`;

    // Support/resistance
    const posAbove=sorted.filter(s=>s.strike>spot&&s.net_gex>mx*.12).slice(0,1);
    const posBelow=sorted.filter(s=>s.strike<spot&&s.net_gex>mx*.12).reverse().slice(0,1);
    const resist=posAbove.length?fp(posAbove[0].strike):(gw?fp(gw):'‚Äî');
    const support=posBelow.length?fp(posBelow[0].strike):(pw?fp(pw):'‚Äî');

    const c=document.createElement('div');c.className=`rec ${bias}`;
    c.innerHTML=`<div class="rec-sym">${sym} $${fp(spot)} <span class="rec-badge ${bias}">${bias.toUpperCase()}</span></div>`+
      `<div class="rec-sum">${r.summary||''}</div>`+
      `<div class="rec-gamma ${gpClass}">${commentary}<br><span style="font-size:8px;color:var(--dim);margin-top:2px;display:inline-block">${dirLine}</span></div>`+
      `<div>${(r.action_items||[]).map(i=>`<div class="rec-act"><span>${i.includes('‚Üë')?'üü£':i.includes('‚Üì')?'üü£':i.includes('SUPPORT')?'üü°':i.includes('RESIST')?'üü°':'‚òÖ'}</span>${i}</div>`).join('')}</div>`+
      `<div class="rec-lvls">`+
        `<span class="rec-lv king">‚òÖ King: ${fp(king?king.strike:0)}</span>`+
        `<span class="rec-lv gp">${gpLabel}</span>`+
        `${r.expected_range?`<span class="rec-lv rng">Range: ${fp(r.expected_range.low)}‚Äì${fp(r.expected_range.high)}</span>`:''}`+
      `</div>`+
      `<div style="display:flex;gap:10px;margin-top:6px;font-size:8px;color:var(--dim)"><span>üü° Support: ${support}</span><span>üü† Resist: ${resist}</span></div>`;
    rw.appendChild(c);
  });
}

// ‚îÄ‚îÄ‚îÄ Heatmap panel ‚îÄ‚îÄ‚îÄ
function renderPanel(d){
  const{symbol,spot,strikes,total_net_gex,gamma_wall,put_wall}=d;
  const n=+document.getElementById('ns').value;
  const sorted=[...strikes].sort((a,b)=>a.strike-b.strike);
  if(!sorted.length)return document.createElement('div');
  const ci=sorted.reduce((b,s,i)=>Math.abs(s.strike-spot)<Math.abs(sorted[b].strike-spot)?i:b,0);
  const vis=sorted.slice(Math.max(0,ci-n),Math.min(sorted.length,ci+n+1)).reverse();
  const mx=Math.max(...vis.map(s=>Math.abs(s.net_gex)),1);
  const ss=sorted[ci]?.strike;
  const ks=vis.reduce((b,s)=>(s.total_gamma||Math.abs(s.net_gex))>(b.total_gamma||Math.abs(b.net_gex))?s:b).strike;
  const pc=total_net_gex>mx*.05?'pos':total_net_gex<-mx*.05?'neg':'neu';
  const pl=pc==='pos'?'+Gamma':pc==='neg'?'‚àíGamma':'Neutral';
  const pd=pc==='pos'?'Vol‚Üì Mean revert':pc==='neg'?'Vol‚Üë Momentum':'Choppy';
  const kingD=ks-spot,kingP=((kingD/spot)*100).toFixed(2);

  const p=document.createElement('div');p.className='panel';
  const trackHtml = getTrackingHtml(symbol);
  p.innerHTML=`<div class="panel-hdr"><span class="panel-sym">${symbol}</span><span class="panel-price">$${fp(spot)}</span></div><div class="panel-sub"><span>Net GEX: ${fg(total_net_gex)}</span><span>${d.expirations?d.expirations.length+' exp':''}</span></div><div class="panel-gp"><span class="gbadge ${pc}">${pl}</span><span style="font-size:9px;color:var(--dim)">${pd}</span></div><div class="klevels"><span class="klev kn">‚òÖ ${fp(ks)}</span><span class="klev gw">Œì ${fp(gamma_wall)}</span><span class="klev pw">P ${fp(put_wall)}</span><span class="klev sp">‚óè ${fp(spot)}</span></div><div style="padding:2px 14px;font-size:8px;color:var(--king);border-bottom:1px solid var(--border)">${kingD>0?'‚Üë':'‚Üì'} $${Math.abs(kingD).toFixed(2)} (${kingP}%) ${kingD>0?'above':'below'} spot</div>${trackHtml}<div class="strikes" id="s-${symbol}"></div>`;
  const cont=p.querySelector(`#s-${symbol}`);

  // Volume surge strikes to highlight
  const surgeStrikes = new Set((d.volume_surges||[]).map(v=>v.strike));

  vis.forEach(s=>{
    const iS=s.strike===ss,iK=s.strike===ks,iV=surgeStrikes.has(s.strike);
    const co=gc(s.net_gex,mx,iK);const tco=tc(s.net_gex,mx,iK);
    const bgA=0.15+Math.min(1,Math.abs(s.net_gex)/mx)*0.6;
    const row=document.createElement('div');row.className='sr'+(iS?' spot':'')+(iK?' king':'');
    if(iV) row.style.borderRight='3px solid var(--cyan)';
    row.innerHTML=`<div class="sr-bg" style="background:rgba(${co.r},${co.g},${co.b},${bgA})"></div><span class="sr-lbl">${fp(s.strike)}</span><div class="gbar-c"><span class="gval" style="color:${tco}">${fg(s.net_gex)}${iK?' ‚òÖ':''}${iV?' üìà':''}</span></div>`;
    row.onmouseenter=e=>showTip(e,s,symbol,spot,mx,iK);row.onmousemove=moveTip;row.onmouseleave=hideTip;
    cont.appendChild(row);
  });
  return p;
}

function showTip(e,s,sym,spot,mx,iK){const t=document.getElementById('tip');const d=s.strike-spot,c=ct(s.net_gex,mx);document.getElementById('tt').textContent=(iK?'‚òÖ ':'')+sym+' ‚Äî $'+fp(s.strike);document.getElementById('tb').innerHTML=`<div class="tip-r"><span class="tip-l">Net GEX</span><span class="tip-v">${fg(s.net_gex)}</span></div><div class="tip-r"><span class="tip-l">Call GEX</span><span class="tip-v" style="color:#fde68a">${fg(s.call_gex)}</span></div><div class="tip-r"><span class="tip-l">Put GEX</span><span class="tip-v" style="color:#d8b4fe">${fg(s.put_gex)}</span></div><div class="tip-d"></div><div class="tip-r"><span class="tip-l">Call OI</span><span class="tip-v">${(s.call_oi||0).toLocaleString()}</span></div><div class="tip-r"><span class="tip-l">Put OI</span><span class="tip-v">${(s.put_oi||0).toLocaleString()}</span></div><div class="tip-r"><span class="tip-l">Call Vol</span><span class="tip-v">${(s.call_volume||0).toLocaleString()}</span></div><div class="tip-r"><span class="tip-l">Put Vol</span><span class="tip-v">${(s.put_volume||0).toLocaleString()}</span></div>${s.call_bid?`<div class="tip-r"><span class="tip-l">Call Bid/Ask</span><span class="tip-v">$${s.call_bid.toFixed(2)}/$${s.call_ask.toFixed(2)}</span></div>`:''}${s.put_bid?`<div class="tip-r"><span class="tip-l">Put Bid/Ask</span><span class="tip-v">$${s.put_bid.toFixed(2)}/$${s.put_ask.toFixed(2)}</span></div>`:''}<div class="tip-r"><span class="tip-l">From Spot</span><span class="tip-v">${d>=0?'+':''}${d.toFixed(1)} (${((d/spot)*100).toFixed(2)}%)</span></div><div class="tip-d"></div><div class="tip-b">${bh(c,iK)}</div>`;t.classList.add('vis');moveTip(e)}
function moveTip(e){const t=document.getElementById('tip');const x=e.clientX+16,y=e.clientY-10;t.style.left=(x+t.offsetWidth>window.innerWidth?e.clientX-t.offsetWidth-16:x)+'px';t.style.top=(y+t.offsetHeight>window.innerHeight?window.innerHeight-t.offsetHeight-8:y)+'px'}
function hideTip(){document.getElementById('tip').classList.remove('vis')}

// ‚ïê‚ïê‚ïê IWM TOGGLE ‚ïê‚ïê‚ïê
let showIWM = true;
function toggleIWM(){
  showIWM = !showIWM;
  document.getElementById('iwmBtn').textContent = showIWM ? 'IWM: ON' : 'IWM: OFF';
  document.getElementById('iwmBtn').style.opacity = showIWM ? '1' : '0.5';
  rerender();
}

function getVisibleSyms(){
  if(!D) return [];
  return Object.keys(D).filter(s=> showIWM || s!=='IWM').sort((a,b)=>a==='SPX'?-1:b==='SPX'?1:0);
}

function rerender(){if(!D)return;renderRecs();if(stratVisible)renderStrats();const c=document.getElementById('hc');c.innerHTML='';
  getVisibleSyms().forEach(s=>c.appendChild(renderPanel(D[s])));updateTimestamp()}

function updateTimestamp(){const ts=D?.[Object.keys(D)[0]]?.timestamp;if(ts)document.getElementById('st').textContent=`Updated ${new Date(ts).toLocaleTimeString()}`}

// ‚ïê‚ïê‚ïê AUTO-RELOAD ‚ïê‚ïê‚ïê
let autoFile=null,autoInterval=null;
function loadFile(e){const f=e.target.files[0];if(!f)return;autoFile=f;readAndRender(f);startAutoReload()}
function readAndRender(f){const r=new FileReader();r.onload=ev=>{try{const nd=JSON.parse(ev.target.result);const nt=nd[Object.keys(nd)[0]]?.timestamp;const ot=D?.[Object.keys(D||{})[0]]?.timestamp;if(nt!==ot||!D){D=nd;document.getElementById('sb').classList.remove('vis');document.getElementById('sd').className='status-dot live';rerender()}}catch(e){console.error(e)}};r.readAsText(f)}
function startAutoReload(){if(autoInterval)clearInterval(autoInterval);autoInterval=setInterval(()=>{if(autoFile)readAndRender(autoFile)},30000);document.getElementById('st').textContent='Auto-reload ON (30s)'}
function stopAutoReload(){if(autoInterval){clearInterval(autoInterval);autoInterval=null}document.getElementById('st').textContent='Auto-reload OFF'}

function loadSample(){
  const sp={SPX:6974,SPY:695,QQQ:615,IWM:267};D={};
  Object.keys(sp).forEach(sym=>{
    const spot=sp[sym]*(1+(Math.random()-.5)*.002),step=sym==='SPX'?5:1;
    const strikes=[],center=Math.round(spot/step)*step;
    const scale=sym==='SPX'?1:sym==='SPY'?8:sym==='QQQ'?1.5:0.4;
    for(let i=-25;i<=25;i++){
      const strike=center+i*step;let net;const decay=Math.exp(-Math.abs(i)*.07);
      if(Math.abs(i)<=1)net=(Math.random()-.4)*15e3*scale;
      else if(i>0){net=12e3*(.05+Math.random()*.5)*decay*scale;if(strike%(step*10)===0)net*=2.5+Math.random()*2}
      else{net=-12e3*(.05+Math.random()*.5)*decay*scale;if(strike%(step*10)===0)net*=2.5+Math.random()*2}
      if(i===-1)net=35e3*scale;
      const cg=Math.abs(net)*(.5+Math.random()*.4),pg=Math.abs(net)*(.3+Math.random()*.3);
      strikes.push({strike,net_gex:net,call_gex:net>0?cg:cg*.3,put_gex:net<0?-pg:-pg*.2,total_gamma:cg+pg,call_oi:~~(Math.random()*12e3+100),put_oi:~~(Math.random()*12e3+100),call_volume:~~(Math.random()*5e3),put_volume:~~(Math.random()*5e3),call_bid:Math.max(0,(20-Math.abs(i)*1.2)+Math.random()*2)*1,call_ask:Math.max(.05,(20-Math.abs(i)*1.1)+Math.random()*3)*1,put_bid:Math.max(0,(15-Math.abs(i)*1)+Math.random()*2)*1,put_ask:Math.max(.05,(15-Math.abs(i)*.9)+Math.random()*3)*1,call_iv:18+Math.random()*8,put_iv:20+Math.random()*10,call_delta:Math.max(0,.5-i*.03),put_delta:Math.min(0,-.5-i*.03)})
    }
    strikes.sort((a,b)=>a.strike-b.strike);
    const tot=strikes.reduce((s,x)=>s+x.net_gex,0);
    // Simulate king history ‚Äî king moved from +10pts to current
    const origKing=center+step*2;
    const kingNow=strikes.reduce((b,s)=>s.total_gamma>b.total_gamma?s:b);
    const now=new Date();
    D[sym]={symbol:sym,spot,timestamp:now.toISOString(),expirations:['2026-02-11'],total_net_gex:tot,
      gamma_wall:strikes.reduce((b,s)=>s.net_gex>b.net_gex?s:b).strike,
      put_wall:strikes.reduce((b,s)=>s.net_gex<b.net_gex?s:b).strike,
      king_node:kingNow.strike,strikes,
      king_history:[
        {strike:origKing,timestamp:new Date(now-2*3600000).toISOString(),spot:spot+5},
        {strike:origKing-step,timestamp:new Date(now-3600000).toISOString(),spot:spot+2},
        {strike:kingNow.strike,timestamp:now.toISOString(),spot},
      ],
      volume_surges:[
        {strike:center-step*3,prev_vol:800,curr_vol:2400,delta:1600,pct:200,call_vol:1200,put_vol:1200},
        {strike:center+step*5,prev_vol:500,curr_vol:1100,delta:600,pct:120,call_vol:900,put_vol:200},
      ],
    }
  });
  document.getElementById('sb').classList.add('vis');document.getElementById('sd').className='status-dot live';document.getElementById('st').textContent='Sample (0DTE)';rerender()
}
// ‚ïê‚ïê‚ïê SERVER AUTO-FETCH (every 5 min) ‚ïê‚ïê‚ïê
let serverInterval = null;
let fetchAttempts = 0;
async function fetchFromServer() {
  try {
    const resp = await fetch('/api/gex');
    if (!resp.ok) {
      fetchAttempts++;
      if (fetchAttempts <= 2) document.getElementById('st').textContent = `Server error (${resp.status}) ‚Äî retrying...`;
      return;
    }
    const newD = await resp.json();
    if (newD && Object.keys(newD).length > 0) {
      const newTs = newD[Object.keys(newD)[0]]?.timestamp;
      const oldTs = D?.[Object.keys(D||{})[0]]?.timestamp;
      if (newTs !== oldTs || !D) {
        D = newD;
        document.getElementById('sb').classList.remove('vis');
        document.getElementById('sd').className = 'status-dot live';
        rerender();
        document.getElementById('st').textContent = `Live ¬∑ Updated ${new Date(newTs).toLocaleTimeString()}`;
        fetchAttempts = 0;
      }
    } else {
      fetchAttempts++;
      if (!D) {
        document.getElementById('st').textContent = 'Waiting for data (market may be closed)';
        document.getElementById('hc').innerHTML = '<div class="empty"><h2>Waiting for Market Data</h2><p>The fetcher is running but market may be closed. Data will appear automatically when available.</p><p style="margin-top:8px;font-size:11px;color:var(--dim)">Or click <code>üß™ Sample</code> to preview with demo data.</p></div>';
      }
    }
  } catch(e) {
    fetchAttempts++;
    if (fetchAttempts <= 2) document.getElementById('st').textContent = 'Connecting to server...';
    else document.getElementById('st').textContent = 'Server unreachable ‚Äî use üìÇ Load JSON';
    // Show Load JSON button as fallback after repeated failures
    if (fetchAttempts >= 3) document.querySelectorAll('.localOnly').forEach(el => el.style.display = 'flex');
  }
}

function startServerFetch() {
  fetchFromServer();
  if (serverInterval) clearInterval(serverInterval);
  serverInterval = setInterval(fetchFromServer, 5 * 60 * 1000);
  document.getElementById('st').textContent = 'Connecting...';
}

// ‚ïê‚ïê‚ïê MODE DETECTION ‚ïê‚ïê‚ïê
if (window.location.protocol !== 'file:') {
  startServerFetch();
} else {
  document.querySelectorAll('.localOnly').forEach(el => el.style.display = 'flex');
}
</script>
</body></html>
