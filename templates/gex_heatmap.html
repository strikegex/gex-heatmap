<!DOCTYPE html>
<!-- saved from url=(0048)file:///Users/kevin/Downloads/gex_heatmap_2.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Heatmap + Strategy</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08080d;--panel:#0e0e16;--card:#12121c;--border:#1a1a2a;--text:#b8b8cc;--dim:#555570;--bright:#e8e8f4;--yellow:#fbbf24;--purple:#a855f7;--green:#22c55e;--king:#ef4444;--accent:#6366f1;--red:#ef4444;--cyan:#06b6d4}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;font-size:14px}

/* ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;gap:8px}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar-title{font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700;color:var(--bright);letter-spacing:-.5px;white-space:nowrap}
.topbar-title em{font-style:normal;color:var(--accent)}
.market-session{font-size:10px;padding:4px 10px;border-radius:4px;font-weight:600;white-space:nowrap}
.market-session.pre{background:rgba(251,191,36,.1);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.market-session.open{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.market-session.power{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.market-session.closed{background:rgba(85,85,112,.1);color:var(--dim);border:1px solid rgba(85,85,112,.2)}
.topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.topbar-right .disc{font-size:7px;color:var(--dim);opacity:.6;max-width:160px;line-height:1.3}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--red);flex-shrink:0}
.status-dot.live{background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-text{font-size:12px;color:var(--dim);white-space:nowrap}
.countdown{font-size:11px;color:var(--accent);font-weight:600;white-space:nowrap}

/* ‚ïê‚ïê‚ïê ACCOUNT MENU ‚ïê‚ïê‚ïê */
.acct-menu{position:relative}
.acct-btn{font-size:11px;padding:5px 10px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:4px;cursor:pointer}
.acct-btn:hover{background:var(--border);color:var(--bright)}
.acct-drop{display:none;position:absolute;top:100%;right:0;margin-top:6px;background:var(--panel);border:1px solid var(--border);border-radius:6px;min-width:160px;padding:6px 0;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.5)}
.acct-drop.vis{display:block}
.acct-drop a{display:block;padding:8px 14px;font-size:12px;color:var(--text);text-decoration:none;transition:background .1s}
.acct-drop a:hover{background:rgba(255,255,255,.05);color:var(--bright)}

/* ‚ïê‚ïê‚ïê CONTROLS ‚Äî single compact row ‚ïê‚ïê‚ïê */
.ctrl{display:flex;gap:8px;padding:8px 20px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;align-items:center}
button,select{font-family:'JetBrains Mono',monospace;font-size:12px;background:var(--card);color:var(--text);border:1px solid var(--border);padding:6px 12px;border-radius:4px;cursor:pointer;transition:all .15s}
button:hover{background:var(--border);color:var(--bright);border-color:var(--accent)}
.ctrl label{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.ctrl-g{display:flex;align-items:center;gap:6px}

/* ‚ïê‚ïê‚ïê LEGEND ‚Äî compact inline ‚ïê‚ïê‚ïê */
.legend{display:flex;gap:12px;padding:4px 20px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;align-items:center}
.legend-t{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.legend-i{display:flex;align-items:center;gap:4px;font-size:9px}
.lsw{width:11px;height:11px;border-radius:2px;flex-shrink:0}
.lsw.y{background:#8ab030}.lsw.p{background:#4040b0}.lsw.g{background:#1e4040}
.lsw.k{background:var(--king);position:relative}
.lsw.k::after{content:"üëë";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:7px}
.legend-d{color:var(--dim);font-size:8px}

.sample-banner{display:none;padding:5px 24px;background:rgba(251,191,36,.06);border-bottom:1px solid rgba(251,191,36,.15);font-size:10px;color:var(--yellow);text-align:center}
.sample-banner.vis{display:block}

/* ‚îÄ‚îÄ‚îÄ Rec Cards ‚îÄ‚îÄ‚îÄ */
.rec-wrap{display:none;padding:12px 24px;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.rec-wrap.vis{display:flex}
.rec{flex:1;min-width:280px;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:14px 16px;position:relative;overflow:hidden}
.rec::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.rec.range::before{background:var(--yellow)}.rec.trend::before{background:var(--purple)}.rec.chop::before{background:var(--green)}.rec.bullish::before{background:var(--green)}.rec.bearish::before{background:var(--red)}
.rec-sym{font-family:'Space Grotesk',sans-serif;font-size:20px;font-weight:700;color:var(--bright);display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.rec-badge{font-size:11px;padding:3px 10px;border-radius:3px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.rec-badge.range{background:rgba(251,191,36,.12);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.rec-badge.trend{background:rgba(168,85,247,.12);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.rec-badge.chop{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.rec-badge.bullish{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.rec-badge.bearish{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.rec-sum{font-size:15px;color:var(--bright);font-weight:600;line-height:1.5;margin-bottom:8px}
.rec-gamma{font-size:13px;padding:10px 12px;border-radius:4px;margin-bottom:10px;line-height:1.7}
.rec-gamma.neg{background:rgba(168,85,247,.06);border-left:3px solid var(--purple);color:var(--text)}
.rec-gamma.pos{background:rgba(251,191,36,.06);border-left:3px solid var(--yellow);color:var(--text)}
.rec-gamma.neu{background:rgba(34,197,94,.06);border-left:3px solid var(--green);color:var(--text)}
.rec-gamma strong{color:var(--bright)}.rec-gamma .hl{color:var(--king);font-weight:600}
.rec-act{font-size:9px;padding:2px 0;display:flex;align-items:baseline;gap:5px;color:var(--text)}
.rec-lvls{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.rec-lv{font-size:10px;padding:3px 8px;border-radius:3px}
.rec-lv.king{background:rgba(245,158,11,.12);color:var(--king);border:1px solid rgba(245,158,11,.25)}
.rec-lv.rng{background:rgba(99,102,241,.08);color:var(--accent);border:1px solid rgba(99,102,241,.2)}
.rec-lv.gp{background:rgba(168,85,247,.08);color:var(--purple);border:1px solid rgba(168,85,247,.2)}

/* ‚ïê‚ïê‚ïê STRATEGY PANEL ‚ïê‚ïê‚ïê */
.strat-wrap{display:none;padding:12px 24px;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.strat-wrap.vis{display:flex}
.strat-card{flex:1;min-width:280px;max-width:480px;background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.strat-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.strat-sym{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;color:var(--bright)}
.strat-type-badge{font-size:9px;padding:3px 8px;border-radius:4px;font-weight:600;letter-spacing:.3px}
.strat-type-badge.ic{background:rgba(251,191,36,.12);color:var(--yellow);border:1px solid rgba(251,191,36,.25)}
.strat-type-badge.cs{background:rgba(168,85,247,.12);color:var(--purple);border:1px solid rgba(168,85,247,.25)}
.strat-type-badge.bf{background:rgba(6,182,212,.12);color:var(--cyan);border:1px solid rgba(6,182,212,.25)}
.strat-type-badge.ds{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.25)}
.strat-type-badge.dg{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25)}

.strat-body{padding:14px 16px}
.strat-name{font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700;color:var(--bright);margin-bottom:4px}
.strat-rationale{font-size:10px;color:var(--text);line-height:1.7;margin-bottom:12px;padding:8px 10px;background:rgba(255,255,255,.02);border-radius:4px;border-left:3px solid var(--king)}

.strat-legs{margin-bottom:12px}
.strat-legs-title{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.strat-leg{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.02);border-radius:4px;margin-bottom:3px;font-size:11px}
.strat-leg-action{font-weight:700;width:40px;text-align:center;padding:2px 0;border-radius:3px;font-size:9px}
.strat-leg-action.sell{background:rgba(239,68,68,.15);color:var(--red)}
.strat-leg-action.buy{background:rgba(34,197,94,.15);color:var(--green)}
.strat-leg-type{color:var(--dim);width:40px}
.strat-leg-strike{color:var(--bright);font-weight:600;flex:1}
.strat-leg-tag{font-size:8px;padding:1px 5px;border-radius:3px}
.strat-leg-tag.gw{background:rgba(251,191,36,.1);color:var(--yellow)}
.strat-leg-tag.pw{background:rgba(168,85,247,.1);color:var(--purple)}
.strat-leg-tag.kn{background:rgba(245,158,11,.1);color:var(--king)}
.strat-leg-tag.sp{background:rgba(255,255,255,.06);color:var(--dim)}

.strat-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.strat-detail{background:rgba(255,255,255,.02);border-radius:4px;padding:8px 10px;text-align:center}
.strat-detail-label{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.strat-detail-val{font-size:13px;font-weight:600;color:var(--bright)}
.strat-detail-val.profit{color:var(--green)}
.strat-detail-val.risk{color:var(--red)}

.strat-why{font-size:9px;color:var(--dim);line-height:1.6;padding:8px 10px;background:rgba(255,255,255,.015);border-radius:4px;border:1px solid var(--border)}
.strat-why strong{color:var(--text)}
.strat-why em{font-style:normal;color:var(--yellow)}
.strat-why .pur{color:var(--purple)}

.strat-disclaimer{font-size:8px;color:var(--dim);padding:8px 16px;border-top:1px solid var(--border);text-align:center;letter-spacing:.3px}

/* ‚îÄ‚îÄ‚îÄ Heatmap ‚îÄ‚îÄ‚îÄ */
.hm-wrap{display:flex;gap:2px;padding:12px 20px;overflow-x:auto;min-height:calc(100vh - 300px)}
.panel{flex:1;min-width:320px;max-width:600px;background:var(--panel);border:1px solid var(--border);border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
.panel-hdr{display:flex;justify-content:space-between;align-items:baseline;padding:12px 14px 8px;border-bottom:1px solid var(--border)}
.panel-sym{font-family:'Space Grotesk',sans-serif;font-size:22px;font-weight:700;color:var(--bright)}
.panel-price{font-size:20px;font-weight:600;color:var(--bright)}
.panel-sub{display:flex;justify-content:space-between;padding:4px 14px 5px;border-bottom:1px solid var(--border)}
.panel-sub span{font-size:13px;color:var(--dim)}
.panel-gp{padding:6px 14px;border-bottom:1px solid var(--border);font-size:14px;display:flex;justify-content:space-between;align-items:center}
.gbadge{padding:4px 10px;border-radius:4px;font-size:12px;font-weight:600}
.gbadge.pos{background:rgba(251,191,36,.12);color:var(--yellow)}.gbadge.neg{background:rgba(168,85,247,.12);color:var(--purple)}.gbadge.neu{background:rgba(34,197,94,.12);color:var(--green)}
.klevels{display:flex;gap:6px;padding:6px 14px 7px;border-bottom:1px solid var(--border);flex-wrap:wrap}
.klev{font-size:11px;padding:4px 8px;border-radius:3px;text-transform:uppercase;letter-spacing:.3px}
.klev.gw{background:rgba(251,191,36,.1);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.klev.pw{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.klev.kn{background:rgba(239,68,68,.12);color:var(--king);border:1px solid rgba(239,68,68,.2)}
.klev.sp{background:rgba(255,255,255,.05);color:var(--bright);border:1px solid rgba(255,255,255,.1)}
.strikes{flex:1;overflow-y:auto;padding:2px 0}
.sr{display:flex;align-items:center;height:36px;padding:0 4px;position:relative;cursor:default;transition:background .1s}
.sr:hover{outline:1px solid rgba(255,255,255,.15);z-index:1}
.sr.spot{outline:2px solid #fff;z-index:2}
.sr.king{outline:none;z-index:5;border:4px solid #ff0000;box-shadow:0 0 16px rgba(255,0,0,.5),inset 0 0 8px rgba(255,0,0,.15);border-radius:4px;margin:2px 0}
.sr-bg{position:absolute;top:0;bottom:0;transition:opacity .15s}
.sr:hover .sr-bg{opacity:.85}
.sr-lbl{width:90px;font-size:15px;font-weight:500;text-align:right;padding-right:10px;flex-shrink:0;z-index:1;position:relative;color:var(--text)}
.sr.spot .sr-lbl{color:#fff;font-weight:700}
.sr.spot .sr-lbl::after{content:" ‚ñ∏"}
.sr.king .sr-lbl{color:#ff4444;font-weight:700}
.sr.king .sr-lbl::before{content:"üëë ";font-size:13px}
.gbar-c{flex:1;height:100%;position:relative;display:flex;align-items:center;justify-content:flex-end}
.gval{font-size:15px;font-weight:600;position:relative;z-index:1;padding:0 10px;white-space:nowrap;min-width:80px;text-align:right}

/* ‚ïê‚ïê‚ïê MOBILE RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:900px){
  .topbar{padding:8px 12px}
  .topbar-title{font-size:14px}
  .topbar-right .disc{display:none}
  .ctrl{padding:6px 12px;gap:6px}
  .legend{padding:3px 12px;gap:8px}
  .hm-wrap{flex-direction:column;padding:8px 8px;gap:8px;overflow-x:hidden}
  .panel{min-width:100%;max-width:100%}
  .rec-wrap{padding:8px 8px;gap:6px}
  .rec{min-width:100%}
  .strat-wrap{padding:8px 8px}
  .strat-card{min-width:100%}
  .panel-sym{font-size:16px}.panel-price{font-size:16px}
  .sr{height:36px}
  .sr-lbl{font-size:14px;width:85px}
  .gval{font-size:14px}
}
@media(max-width:480px){
  .topbar-left{gap:6px}
  .topbar-title{font-size:12px}
  .market-session{font-size:8px;padding:3px 6px}
  .ctrl{padding:4px 8px}
  button,select{font-size:10px;padding:4px 8px}
  .legend{display:none}
  .sr-lbl{width:70px;font-size:12px}
  .gval{font-size:12px;min-width:60px}
}

.tip{display:none;position:fixed;background:#14142a;border:1px solid var(--border);border-radius:6px;padding:10px 14px;font-size:11px;z-index:100;pointer-events:none;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:240px}
.tip.vis{display:block}
.tip-t{font-weight:600;color:var(--bright);margin-bottom:6px;font-size:12px}
.tip-r{display:flex;justify-content:space-between;gap:14px;margin:3px 0}
.tip-l{color:var(--dim)}.tip-v{color:var(--bright);font-weight:500}
.tip-d{border-top:1px solid var(--border);margin:5px 0}
.tip-b{font-size:9px;color:var(--dim);margin-top:4px;line-height:1.5}
.tip-b strong{color:var(--text)}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh;gap:12px;text-align:center;padding:40px}
.empty h2{font-family:'Space Grotesk',sans-serif;font-size:15px;color:var(--bright)}
.empty p{font-size:12px;color:var(--dim);max-width:440px;line-height:1.7}
.empty code{background:var(--card);padding:2px 6px;border-radius:3px;font-size:10px;color:var(--accent)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
.footer{padding:16px 24px;border-top:1px solid var(--border);background:var(--panel);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
.footer-left{display:flex;align-items:center;gap:16px}
.footer-social a{color:var(--dim);text-decoration:none;font-size:12px;display:inline-flex;align-items:center;gap:4px;transition:color .15s}
.footer-social a:hover{color:var(--bright)}
.footer-copy{font-size:10px;color:var(--dim)}

/* ‚ïê‚ïê‚ïê LOGIN OVERLAY ‚ïê‚ïê‚ïê */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center}
.login-overlay.hidden{display:none}
.login-box{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:40px 36px;width:340px;max-width:90vw;text-align:center}
.login-box h2{font-family:'Space Grotesk',sans-serif;font-size:20px;color:var(--bright);margin-bottom:6px}
.login-box h2 em{font-style:normal;color:var(--accent)}
.login-box p{font-size:11px;color:var(--dim);margin-bottom:24px}
.login-box input{width:100%;padding:10px 14px;margin-bottom:12px;font-family:'JetBrains Mono',monospace;font-size:13px;background:var(--card);color:var(--bright);border:1px solid var(--border);border-radius:6px;outline:none}
.login-box input:focus{border-color:var(--accent)}
.login-box .login-btn{width:100%;padding:10px;font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:600;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;transition:opacity .15s}
.login-box .login-btn:hover{opacity:.85}
.login-box .login-err{font-size:11px;color:var(--red);margin-top:8px;display:none}
</style>
</head>
<body>
<!-- ‚ïê‚ïê‚ïê LOGIN OVERLAY ‚ïê‚ïê‚ïê -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2><em>GEX</em> Heatmap</h2>
    <p>Restricted access. Enter your credentials.</p>
    <input type="text" id="loginUser" placeholder="Username" autocomplete="username">
    <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="loginErr">Invalid username or password</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APP (hidden until authenticated) ‚ïê‚ïê‚ïê -->
<div id="appWrap" style="display:none">
<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-title"><em>GEX</em> Heatmap</span>
    <span class="market-session closed" id="mktSession">CLOSED</span>
  </div>
  <div class="topbar-right">
    <span class="disc">Educational only ¬∑ Not financial advice</span>
    <span class="countdown" id="countdown"></span>
    <div class="status-dot" id="sd"></div>
    <span class="status-text" id="st">Connecting...</span>
    <div class="acct-menu">
      <button onclick="document.getElementById('acctDrop').classList.toggle('vis')" class="acct-btn">üë§ Account</button>
      <div class="acct-drop" id="acctDrop">
        <a href="#" onclick="event.preventDefault()">üìä Dashboard</a>
        <a href="#" onclick="event.preventDefault()">üí≥ Billing</a>
        <a href="#" onclick="event.preventDefault()">‚öôÔ∏è Settings</a>
        <a href="#" onclick="event.preventDefault()">üì± API Keys</a>
        <div style="border-top:1px solid var(--border);margin:4px 0"></div>
        <a href="#" onclick="event.preventDefault()">üö™ Sign Out</a>
      </div>
    </div>
  </div>
</div>
<div class="ctrl">
  <div class="ctrl-g localOnly" style="display:none"><button onclick="document.getElementById('fi').click()">üìÇ Load</button><input type="file" id="fi" accept=".json" style="display:none" onchange="loadFile(event)"></div>
  <div class="ctrl-g"><button onclick="toggleStrats()" id="stratBtn">üìä Strategy</button></div>
  <div class="ctrl-g"><button onclick="toggleIWM()" id="iwmBtn" style="font-size:10px;opacity:0.5">IWM: OFF</button></div>
  <div class="ctrl-g"><button onclick="toggleColorGuide()" id="cgBtn" style="font-size:9px;padding:3px 8px">? Guide</button></div>
  <div class="ctrl-g" style="margin-left:auto"><label>Strikes:</label>
    <select id="ns" onchange="rerender()"><option value="15" selected="">15</option><option value="25">25</option><option value="40">40</option><option value="60">60</option></select>
  </div>
</div>
<div class="legend">
  <span class="legend-t">Legend:</span>
  <div class="legend-i"><div class="lsw y"></div><span style="color:var(--yellow)">+Gamma</span></div>
  <div class="legend-i"><div class="lsw p"></div><span style="color:var(--purple)">‚àíGamma</span></div>
  <div class="legend-i"><div class="lsw g"></div><span style="color:var(--dim)">Neutral</span></div>
  <div class="legend-i"><div class="lsw k"></div><span style="color:var(--king)">üëë King</span></div>
</div>
<div id="legend-detail" style="display:none;padding:14px 20px;border-bottom:1px solid var(--border);background:var(--panel);font-size:10px;line-height:1.8">
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
    <div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--yellow);margin-bottom:6px">üü° Yellow ‚Äî Positive Gamma (+GEX)</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealers are NET SHORT options at this strike.</div>
      <div style="color:var(--text);margin-top:4px"><strong>How dealers hedge:</strong> They hedge AGAINST the move. If price rises, they sell. If price falls, they buy. This creates <em>mean reversion</em> ‚Äî price snaps back.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Price is "sticky." Acts as support (below) or resistance (above). Vol dampens. Range-bound.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy:</strong> ‚úÖ SELL premium here. Iron condors, credit spreads, butterflies. Dealers defend your position.</div>
    </div>
    <div style="background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--purple);margin-bottom:6px">üü£ Purple ‚Äî Negative Gamma (‚àíGEX)</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealers are NET LONG options at this strike.</div>
      <div style="color:var(--text);margin-top:4px"><strong>How dealers hedge:</strong> They hedge WITH the move. Price rises ‚Üí they buy more. Falls ‚Üí they sell more. This creates <em>momentum</em> ‚Äî moves accelerate.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Price is "slippery." Breakouts carry through. Vol expands. Trending action.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy:</strong> ‚ö†Ô∏è DO NOT sell premium. Dealers amplify against you. Buy debit spreads, ride momentum, or stay away.</div>
    </div>
    <div style="background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--green);margin-bottom:6px">üü¢ Green ‚Äî Neutral / Mixed</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealer positioning is roughly balanced. No strong directional bias.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Choppy, indecisive. No strong pull either way. Low conviction zone.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy:</strong> ‚ö™ Reduce size. Wait for clearer setup. Can flip +/‚àí without warning.</div>
    </div>
    <div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--king);margin-bottom:6px">üëë King Node ‚Äî Max Absolute Gamma</div>
      <div style="color:var(--text)"><strong>What it means:</strong> The strike with the LARGEST absolute gamma exposure. Most dealer hedging activity.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Acts as a <em>price magnet</em>. Spot drifts toward king throughout the day, especially during 0DTE. Think gravity.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy:</strong> üëë This is your TARGET. Center butterflies here. King above spot ‚Üí bullish drift. Below ‚Üí bearish. At spot ‚Üí pin, ideal for ICs.</div>
    </div>
  </div>
</div>
<div class="sample-banner" id="sb">‚ö† Sample data</div>

<!-- Recs -->
<div class="rec-wrap" id="rw"></div>

<!-- King/volume tracking is now inside each panel -->

<!-- Strategy (hidden by default) -->
<div class="strat-wrap" id="sw"></div>

<!-- Tooltip -->
<div class="tip" id="tip"><div class="tip-t" id="tt"></div><div id="tb"></div></div>

<!-- Heatmap -->
<div class="hm-wrap" id="hc">
  <div class="empty"><h2>Load GEX Data</h2><p>Click <code>üìÇ Load JSON</code> or <code>üß™ Sample</code></p></div>
</div>

<!-- Footer -->
<div class="footer">
  <div class="footer-left">
    <div class="footer-social">
      <a href="https://x.com" target="_blank" rel="noopener">ùïè Follow on X</a>
      <a href="https://discord.gg" target="_blank" rel="noopener" style="margin-left:12px">üí¨ Discord</a>
    </div>
  </div>
  <span class="footer-copy">¬© 2025 StrikeGEX. All rights reserved.</span>
</div>
</div><!-- end appWrap -->

<script>
let D=null;
let openingGEX={}; // Store first fetch of day as baseline

// ‚ïê‚ïê‚ïê AUTH SYSTEM ‚ïê‚ïê‚ïê
function doLogin(){
  const user=document.getElementById('loginUser').value.trim();
  const pass=document.getElementById('loginPass').value;
  const err=document.getElementById('loginErr');
  err.style.display='none';
  fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user,password:pass})})
    .then(r=>r.json()).then(d=>{
      if(d.ok){
        sessionStorage.setItem('gex_auth','1');
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('appWrap').style.display='';
        startServerFetch();
      }else{err.textContent=d.error||'Invalid credentials';err.style.display='block'}
    }).catch(()=>{
      // Fallback for local/file mode
      if(user==='admin'&&pass==='strikegex'){
        sessionStorage.setItem('gex_auth','1');
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('appWrap').style.display='';
      }else{err.textContent='Invalid credentials';err.style.display='block'}
    });
}
// Enter key submits login
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('loginUser').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()});

// Check session on load
if(sessionStorage.getItem('gex_auth')==='1'){
  document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('appWrap').style.display='';
}

// ‚ïê‚ïê‚ïê COLOR ‚Äî solid saturated like reference tool ‚ïê‚ïê‚ïê
function gc(n,m,k){
  // King keeps underlying GEX color ‚Äî NO override
  const r=n/m,a=Math.min(Math.abs(r),1);
  if(a<.01)return{r:30,g:60,b:55};
  if(r>0){
    const t=Math.pow(a,0.5);
    return{r:Math.round(30+190*t),g:Math.round(80+100*t),b:Math.round(55-35*t)};
  }
  const t=Math.pow(a,0.5);
  return{r:Math.round(25+70*t),g:Math.round(50+10*t),b:Math.round(70+110*t)};
}
function tc(n,m,k){
  if(k)return'#ff4444'; // King text RED
  const r=n/m,a=Math.abs(r);
  if(a<.01)return'#556';
  if(a>.3)return'#fff';
  return r>0?'#e8e8d0':'#d0d0e8';
}
function ct(n,m){const r=n/m;return Math.abs(r)<.04?'neutral':r>0?'positive':'negative'}
function bh(c,k){if(k)return'<strong>üëë King</strong> ‚Äî Max Gamma ¬∑ Price Magnet';if(c==='positive')return'<strong>+Gamma</strong> ‚Äî Dealers Short ¬∑ Mean Reversion';if(c==='negative')return'<strong>‚àíGamma</strong> ‚Äî Dealers Long ¬∑ Momentum';return'<strong>Neutral</strong> ‚Äî Choppy'}
function fg(v){const a=Math.abs(v);const s=v<0?'-':'';if(a>=1e9)return s+'$'+(a/1e9).toFixed(1)+'B';if(a>=1e6)return s+'$'+(a/1e6).toFixed(1)+'M';if(a>=1e3)return s+'$'+(a/1e3).toFixed(1)+'K';return s+'$'+a.toFixed(0)}
function fp(p){return p>=1000?p.toFixed(0):p.toFixed(2)}

// ‚ïê‚ïê‚ïê STRATEGY ENGINE ‚Äî 0DTE Conservative ‚ïê‚ïê‚ïê
// 0DTE IC rules: 5-15Œî shorts, $25-30 wings, stop = total credit per side
// Conservative 0DTE strike selection: 10Œî shorts, wide wings
function generateStrategy(d) {
  const {symbol, spot, strikes, total_net_gex} = d;
  if (!strikes || !strikes.length) return null;

  const mx = Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  const king = strikes.reduce((b,s)=>(s.total_gamma||0)>(b.total_gamma||0)?s:b);
  const gw = strikes.reduce((b,s)=>s.net_gex>b.net_gex?s:b);
  const pw = strikes.reduce((b,s)=>s.net_gex<b.net_gex?s:b);
  const posAbove = strikes.filter(s=>s.strike>spot&&s.net_gex>mx*.12).sort((a,b)=>a.strike-b.strike);
  const posBelow = strikes.filter(s=>s.strike<spot&&s.net_gex>mx*.12).sort((a,b)=>b.strike-a.strike);
  const profile = total_net_gex>mx*.1?'positive':total_net_gex<-mx*.1?'negative':'neutral';
  const kd = king.strike-spot, kdPct=(kd/spot)*100;

  const sorted = [...strikes].sort((a,b)=>a.strike-b.strike);
  const step = sorted.length>=2 ? sorted[1].strike-sorted[0].strike : 5;
  const rnd = v => Math.round(v/step)*step;

  // 0DTE WINGS: Tight for 0DTE - $15 SPX, $3 ETFs
  const WING = symbol==='SPX' ? 15 : 3;
  // Spread width for debit spreads: $5 SPX, $2 ETF
  const SPREAD_WIDTH = symbol==='SPX' ? 5 : 2;

  // 0DTE DELTA: 10Œî shorts (conservative, 5-15Œî range)
  // SPX 10Œî ~= 30-40pts OTM, ETFs 10Œî ~= 0.6-0.8% OTM
  function getDeltaStrike(direction, targetDelta) {
    const spxPts = {0.05:50, 0.08:38, 0.10:30, 0.12:25, 0.15:20};
    const etfPct = {0.05:0.010, 0.08:0.007, 0.10:0.006, 0.12:0.005, 0.15:0.004};
    let offset = symbol==='SPX' ? (spxPts[targetDelta]||30) : spot*(etfPct[targetDelta]||0.006);
    return rnd(direction==='call' ? spot+offset : spot-offset);
  }

  function gexValidate(strike, direction) {
    const nearest = sorted.reduce((b,s)=>Math.abs(s.strike-strike)<Math.abs(b.strike-strike)?s:b);
    const gexR = nearest.net_gex/mx;
    let tag='',tagCls='sp',conf='STANDARD',adj=strike;
    if(gexR>.15){tag='+Gamma Wall';tagCls='gw';conf='HIGH';adj=nearest.strike}
    else if(gexR<-.15){
      const cands=direction==='put'?sorted.filter(s=>s.strike<spot&&s.net_gex>mx*.10).sort((a,b)=>b.strike-a.strike):sorted.filter(s=>s.strike>spot&&s.net_gex>mx*.10).sort((a,b)=>a.strike-b.strike);
      if(cands.length){adj=cands[0].strike;tag='+Gamma (shifted)';tagCls='gw';conf='HIGH (adj)'}
      else{tag='‚ö† ‚àíGamma';tagCls='pw';conf='LOW'}
    }else{tag=`~${(Math.abs(strike-spot)/spot*100).toFixed(2)}% OTM`}
    if(Math.abs(adj-king.strike)<=step){tag+=' (üëë King)';tagCls='kn'}
    return{strike:adj,tag,tagCls,conf,orig:strike};
  }

  function estPrem(strike, type) {
    const s=sorted.reduce((b,c)=>Math.abs(c.strike-strike)<Math.abs(b.strike-strike)?c:b);
    const bid=type==='call'?(s.call_bid||0):(s.put_bid||0);
    const ask=type==='call'?(s.call_ask||0):(s.put_ask||0);
    if(bid>0&&ask>0)return `$${bid.toFixed(2)}‚Äì$${ask.toFixed(2)}`;
    if(ask>0)return `~$${ask.toFixed(2)}`;
    return null;
  }

  function driftComm() {
    const dist=Math.abs(kd).toFixed(1),dir=kd>0?'above':'below',pct=Math.abs(kdPct).toFixed(2);
    let c=`<strong>üëë King ${fp(king.strike)}</strong> ‚Äî ${dist}pts ${dir} (${pct}%). `;
    if(Math.abs(kdPct)<.05) c+=`ON the king. <em>Strong pin.</em> Ideal for ICs.`;
    else if(Math.abs(kdPct)<.15) c+=kd>0?`Slight upward pull. <em>Buy dips, sell at king.</em>`:`Slight downward pull. <em>Sell rips, cover at king.</em>`;
    else c+=kd>0?`Strong upward gravity. <em>Bullish ‚Äî buy calls targeting king.</em>`:`Strong downward gravity. <em>Bearish ‚Äî buy puts targeting king.</em>`;
    if(posAbove[0]&&posBelow[0]) c+=` Range: ${fp(posBelow[0].strike)}‚Äì${fp(posAbove[0].strike)}.`;
    return c;
  }

  // ‚ïê‚ïê‚ïê TIME CHECK: After 12PM ET (9AM PST), only safe-to-hold strategies ‚ïê‚ïê‚ïê
  const nowET = new Date().toLocaleString('en-US',{timeZone:'America/New_York',hour:'numeric',minute:'numeric',hour12:false});
  const [etH,etM] = nowET.split(':').map(Number);
  const etMins = etH*60+etM;
  const lateSession = etMins >= 720; // 12:00 PM ET = 9:00 AM PST

  // Spread width for debit spreads already set above

  let strategies = [];

  // ‚ïê‚ïê‚ïê +GAMMA ‚Üí SELL PREMIUM (CONSERVATIVE 0DTE) ‚ïê‚ïê‚ïê
  if (profile === 'positive') {
    if(!lateSession){
      // Iron Condor ‚Äî only before 9AM PST
      const rawSP = getDeltaStrike('put', 0.10);
      const rawSC = getDeltaStrike('call', 0.10);
      const valP = gexValidate(rawSP,'put'), valC = gexValidate(rawSC,'call');
      const sp = valP.strike, sc = valC.strike;
      const lp = sp-WING, lc = sc+WING;
      const sPutN = sorted.reduce((b,c)=>Math.abs(c.strike-sp)<Math.abs(b.strike-sp)?c:b);
      const sCallN = sorted.reduce((b,c)=>Math.abs(c.strike-sc)<Math.abs(b.strike-sc)?c:b);
      const lpN = sorted.reduce((b,c)=>Math.abs(c.strike-lp)<Math.abs(b.strike-lp)?c:b);
      const lcN = sorted.reduce((b,c)=>Math.abs(c.strike-lc)<Math.abs(b.strike-lc)?c:b);
      const pCr = ((sPutN.put_bid||0)+(sPutN.put_ask||0))/2-((lpN.put_bid||0)+(lpN.put_ask||0))/2;
      const cCr = ((sCallN.call_bid||0)+(sCallN.call_ask||0))/2-((lcN.call_bid||0)+(lcN.call_ask||0))/2;
      const totCr = pCr+cCr;
      const premEst = totCr>.10?`~$${totCr.toFixed(2)}/ct ($${(totCr*100).toFixed(0)} per IC)`:`Target ‚Öì of $${WING} wing`;
      strategies.push({
        name:'Iron Condor (0DTE)',type:'ic',
        rationale:`<strong>Conservative 0DTE:</strong> 10Œî shorts, $${WING} wings. +Gamma = dealers dampen vol.`,
        legs:[
          {action:'BUY',type:'PUT',strike:lp,tag:`Wing ($${WING})`,tagCls:'sp'},
          {action:'SELL',type:'PUT',strike:sp,tag:valP.tag,tagCls:valP.tagCls,note:sp!==valP.orig?`(shifted from ${fp(valP.orig)})`:'(~10Œî)'},
          {action:'SELL',type:'CALL',strike:sc,tag:valC.tag,tagCls:valC.tagCls,note:sc!==valC.orig?`(shifted from ${fp(valC.orig)})`:'(~10Œî)'},
          {action:'BUY',type:'CALL',strike:lc,tag:`Wing ($${WING})`,tagCls:'sp'},
        ],
        expectedPremium:premEst,maxProfit:totCr>.10?`$${(totCr*100).toFixed(0)}`:'Credit received',
        maxRisk:totCr>.10?`$${((WING-totCr)*100).toFixed(0)}`:`$${WING*100} minus credit`,
        target:`Stay between ${fp(sp)} ‚Äì ${fp(sc)}`,
        why:[driftComm(),`Close by 3:45pm. Stop = credit per side.`],
      });
    }

    // Butterfly ‚Äî allowed any time (safe to hold)
    if(Math.abs(kdPct)<.25){
      const ctr=rnd(king.strike);
      strategies.push({name:'Butterfly (Pin)',type:'bf',
        rationale:`King near spot + +gamma = pin probability.${lateSession?' Safe to hold to expiry.':''}`,
        legs:[
          {action:'BUY',type:'CALL',strike:ctr-WING,tag:'Lower',tagCls:'sp'},
          {action:'SELL',type:'CALL',strike:ctr,tag:'üëë King',tagCls:'kn',qty:2},
          {action:'BUY',type:'CALL',strike:ctr+WING,tag:'Upper',tagCls:'sp'},
        ],
        expectedPremium:'~$1-$3 debit',maxProfit:`$${WING*100} minus debit`,maxRisk:'Debit paid',target:`Pin ${fp(ctr)}`,
        why:[driftComm(),lateSession?`Late session: butterfly is defined-risk, safe to hold.`:`Enter after 2pm. Small size ‚Äî lottery ticket.`],
      });
    }

    // Conservative call/put ‚Äî allowed any time
    if(kd>spot*.001){
      const cs=rnd(spot),cP=estPrem(cs,'call');
      strategies.push({name:'Buy Call (Drift)',type:'ds',
        rationale:`King above = upward magnet. Conservative single leg.`,
        legs:[{action:'BUY',type:'CALL',strike:cs,tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium:cP?`Cost: ${cP}`:'Check chain',maxProfit:'Unlimited',maxRisk:'Premium paid',target:`Rally to ${fp(king.strike)}`,
        why:[driftComm(),`Take profit 50-100%. Cut at 50% loss.`],
      });
    }
  }

  // ‚ïê‚ïê‚ïê ‚àíGAMMA ‚Üí DIRECTIONAL ‚ïê‚ïê‚ïê
  else if (profile === 'negative') {
    if(kd>0){
      if(!lateSession){
        // Call Debit Spread ‚Äî only before 9AM PST, tight $10/$3 width
        const buyStrike=rnd(spot);
        const sellStrike=rnd(buyStrike+SPREAD_WIDTH);
        const buyPrem=estPrem(buyStrike,'call');
        strategies.push({name:'Call Debit Spread',type:'ds',
          rationale:`‚àíGamma + king above. $${SPREAD_WIDTH}-wide debit spread for defined risk.`,
          legs:[
            {action:'BUY',type:'CALL',strike:buyStrike,tag:'Near ATM',tagCls:'sp',note:'(~50Œî)'},
            {action:'SELL',type:'CALL',strike:sellStrike,tag:'OTM',tagCls:'sp',note:`$${SPREAD_WIDTH} wide`}
          ],
          expectedPremium:buyPrem?`Debit: ${buyPrem}`:'Verify',
          maxProfit:`$${(SPREAD_WIDTH*100).toFixed(0)} minus debit`,maxRisk:'Debit paid',
          target:`Rally to ${fp(sellStrike)}+`,
          why:[driftComm(),`<span class="pur">‚àíGamma = DON'T sell ICs.</span> Buy direction.`,`Take profit 50-75%. Cut at 50% loss.`],
        });
      }
      // Buy Call ‚Äî allowed any time (conservative single leg)
      const cP2=estPrem(rnd(spot),'call');
      strategies.push({name:`Buy Call${lateSession?' (Conservative)':''}`,type:'ds',
        rationale:`‚àíGamma + king above. ${lateSession?'Late session ‚Äî single leg only, defined risk.':'Momentum play.'}`,
        legs:[{action:'BUY',type:'CALL',strike:rnd(spot),tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium:cP2?`Cost: ${cP2}`:'Check chain',maxProfit:'Unlimited',maxRisk:'Premium',target:`${fp(king.strike)}+`,
        why:[driftComm(),lateSession?`Late session: single leg = defined risk. Set hard stop.`:`Trail stop at 50% gains.`],
      });
    }else if(kd<0){
      if(!lateSession){
        // Put Debit Spread ‚Äî only before 9AM PST, tight $10/$3 width
        const buyStrike=rnd(spot);
        const sellStrike=rnd(buyStrike-SPREAD_WIDTH);
        const buyPrem=estPrem(buyStrike,'put');
        strategies.push({name:'Put Debit Spread',type:'ds',
          rationale:`‚àíGamma + king below. $${SPREAD_WIDTH}-wide debit spread for defined risk.`,
          legs:[
            {action:'BUY',type:'PUT',strike:buyStrike,tag:'Near ATM',tagCls:'sp',note:'(~50Œî)'},
            {action:'SELL',type:'PUT',strike:sellStrike,tag:'OTM',tagCls:'sp',note:`$${SPREAD_WIDTH} wide`}
          ],
          expectedPremium:buyPrem?`Debit: ${buyPrem}`:'Verify',
          maxProfit:`$${(SPREAD_WIDTH*100).toFixed(0)} minus debit`,maxRisk:'Debit paid',
          target:`Drop to ${fp(sellStrike)}`,
          why:[driftComm(),`Take profit 50-75%. Cut at 50% loss.`],
        });
      }
      // Buy Put ‚Äî allowed any time
      const pP=estPrem(rnd(spot),'put');
      strategies.push({name:`Buy Put${lateSession?' (Conservative)':''}`,type:'ds',
        rationale:`‚àíGamma + king below. ${lateSession?'Late session ‚Äî single leg only.':'Momentum play.'}`,
        legs:[{action:'BUY',type:'PUT',strike:rnd(spot),tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium:pP?`Cost: ${pP}`:'Check chain',maxProfit:'Substantial',maxRisk:'Premium',target:`${fp(king.strike)}`,
        why:[driftComm(),lateSession?`Late session: single leg = defined risk. Set hard stop.`:`Trail stop at 50% gains.`],
      });
    }

    // Butterfly ‚Äî allowed any time for ‚àígamma too
    if(Math.abs(kdPct)<.3){
      const ctr=rnd(king.strike);
      strategies.push({name:'Butterfly (King Target)',type:'bf',
        rationale:`King at ${fp(ctr)}. Low cost lottery for pin.${lateSession?' Safe defined-risk play.':''}`,
        legs:[
          {action:'BUY',type:'CALL',strike:ctr-WING,tag:'Lower',tagCls:'sp'},
          {action:'SELL',type:'CALL',strike:ctr,tag:'üëë King',tagCls:'kn',qty:2},
          {action:'BUY',type:'CALL',strike:ctr+WING,tag:'Upper',tagCls:'sp'},
        ],
        expectedPremium:'~$1-$3 debit',maxProfit:`$${WING*100} minus debit`,maxRisk:'Debit paid',target:`Pin ${fp(ctr)}`,
        why:[driftComm()],
      });
    }
  }

  // ‚ïê‚ïê‚ïê NEUTRAL ‚ïê‚ïê‚ïê
  else {
    const ctr=rnd(king.strike);
    strategies.push({name:'Iron Butterfly (¬Ω Size)',type:'bf',
      rationale:`Neutral. King at ${fp(ctr)} weak magnet. Half size, tight stops.`,
      legs:[
        {action:'BUY',type:'PUT',strike:ctr-WING,tag:'Put wing',tagCls:'sp'},
        {action:'SELL',type:'PUT',strike:ctr,tag:'üëë King',tagCls:'kn'},
        {action:'SELL',type:'CALL',strike:ctr,tag:'üëë King',tagCls:'kn'},
        {action:'BUY',type:'CALL',strike:ctr+WING,tag:'Call wing',tagCls:'sp'},
      ],
      expectedPremium:'Check chain (ATM)',maxProfit:'Credit',maxRisk:`$${WING*100} minus credit`,target:`Pin ${fp(ctr)}`,
      why:[driftComm(),`25% profit target. Stop at 1√ó credit. Half size.`],
    });
  }

  return strategies;
}

// ‚ïê‚ïê‚ïê KING HISTORY + VOLUME SURGE ‚Äî per-panel (not global bar) ‚ïê‚ïê‚ïê
function getTrackingHtml(sym) {
  if (!D || !D[sym]) return '';
  const d = D[sym];
  let html = '';

  // King history
  const kh = d.king_history || [];
  if (kh.length >= 2) {
    const first = kh[0], last = kh[kh.length-1];
    const mins = Math.round((new Date(last.timestamp)-new Date(first.timestamp))/60000);
    const hrs = mins >= 60 ? `${Math.floor(mins/60)}h${mins%60}m` : `${mins}m`;
    const delta = last.strike - first.strike;
    const dir = delta>0?'‚Üë':delta<0?'‚Üì':'‚Üí';
    html += `<div style="padding:2px 14px;font-size:8px;color:var(--king);border-bottom:1px solid var(--border)">üëë King: ${fp(first.strike)} ‚Üí ${fp(last.strike)} (${delta>0?'+':''}${delta.toFixed(0)}pts ${dir}) ${hrs}`;
    if (kh.length > 2) html += ` ¬∑ ${kh.map(k=>fp(k.strike)).join('‚Üí')}`;
    html += `</div>`;
  }

  // Volume surges
  const vs = d.volume_surges || [];
  if (vs.length > 0) {
    html += `<div style="padding:2px 14px;font-size:8px;color:var(--cyan);border-bottom:1px solid var(--border)">üìà `;
    html += vs.slice(0,3).map(v=>
      `${fp(v.strike)} +${v.delta.toLocaleString()} (${v.pct>0?'+':''}${v.pct}%)`
    ).join(' ¬∑ ');
    html += `</div>`;
  }

  return html;
}

// ‚ïê‚ïê‚ïê STRATEGY TOGGLE ‚ïê‚ïê‚ïê
let stratVisible = false;
function toggleStrats() {
  stratVisible = !stratVisible;
  const sw = document.getElementById('sw'), btn = document.getElementById('stratBtn');
  if (stratVisible) { sw.classList.add('vis'); btn.textContent='üìä Strategy ‚ñ¥'; renderStrats(); }
  else { sw.classList.remove('vis'); btn.textContent='üìä Strategy ‚ñæ'; }
}

function renderStrats() {
  const sw = document.getElementById('sw');
  if (!D||!stratVisible) { sw.classList.remove('vis'); sw.innerHTML=''; return; }
  sw.innerHTML=''; sw.classList.add('vis');

  const syms = Object.keys(D).sort((a,b)=>a==='SPX'?-1:b==='SPX'?1:0);
  syms.forEach(sym => {
    const sd = D[sym]; if(!sd) return;
    const strats = generateStrategy(sd);
    if (!strats||!strats.length) return;
    const s = strats[0];
    const card = document.createElement('div'); card.className='strat-card';
    const legsH = s.legs.map(l=>`<div class="strat-leg"><span class="strat-leg-action ${l.action.toLowerCase()}">${l.action}</span><span class="strat-leg-type">${l.type}</span><span class="strat-leg-strike">${fp(l.strike)}${l.qty?' √ó'+l.qty:''}${l.note?' <span style="color:var(--dim);font-size:9px">'+l.note+'</span>':''}</span><span class="strat-leg-tag ${l.tagCls}">${l.tag}</span></div>`).join('');
    const whyH = s.why.map(w=>`<div style="margin:4px 0">‚Üí ${w}</div>`).join('');
    const altH = strats.length>1?'<div style="padding:8px 16px;border-top:1px solid var(--border);font-size:9px;color:var(--dim)"><strong style="color:var(--text)">Alt:</strong> '+strats.slice(1).map(a=>`<span style="margin-left:6px;padding:2px 6px;background:rgba(255,255,255,.03);border-radius:3px">${a.name}</span>`).join('')+'</div>':'';
    card.innerHTML=`<div class="strat-hdr"><span class="strat-sym">${sym} ¬∑ $${fp(sd.spot)}</span><span class="strat-type-badge ${s.type}">${s.name}</span></div><div class="strat-body"><div class="strat-rationale">${s.rationale}</div><div class="strat-legs"><div class="strat-legs-title">Legs</div>${legsH}</div><div class="strat-details"><div class="strat-detail"><div class="strat-detail-label">Premium</div><div class="strat-detail-val" style="color:var(--cyan);font-size:10px">${s.expectedPremium||'‚Äî'}</div></div><div class="strat-detail"><div class="strat-detail-label">Max Profit</div><div class="strat-detail-val profit">${s.maxProfit}</div></div><div class="strat-detail"><div class="strat-detail-label">Max Risk</div><div class="strat-detail-val risk">${s.maxRisk}</div></div><div class="strat-detail"><div class="strat-detail-label">Target</div><div class="strat-detail-val">${s.target}</div></div></div><div class="strat-why">${whyH}</div></div>${altH}<div class="strat-disclaimer">‚ö† Not financial advice. Verify on live chain.</div>`;
    sw.appendChild(card);
  });

  // Confluence
  if(syms.length>=3){
    const profs=syms.map(s=>{const d=D[s];const m=Math.max(...d.strikes.map(x=>Math.abs(x.net_gex)),1);return d.total_net_gex>m*.1?'pos':d.total_net_gex<-m*.1?'neg':'neu'});
    const all=profs.every(p=>p===profs[0]);
    const cc=document.createElement('div');cc.style.cssText='width:100%;padding:8px 12px;border-radius:6px;font-size:10px;margin-top:4px';
    if(all){cc.style.background='rgba(34,197,94,.08)';cc.style.color='var(--green)';cc.innerHTML=`‚úÖ <strong>Full confluence</strong> ‚Äî All ${profs[0]==='pos'?'+gamma':profs[0]==='neg'?'‚àígamma':'neutral'}.`}
    else{cc.style.background='rgba(251,191,36,.08)';cc.style.color='var(--yellow)';cc.innerHTML=`‚ö† <strong>Mixed signals</strong> ‚Äî Reduce size.`}
    sw.appendChild(cc);
  }
}

// ‚îÄ‚îÄ‚îÄ Recs ‚îÄ‚îÄ‚îÄ
function genRec(d){
  const{spot,strikes,total_net_gex}=d;if(!strikes||!strikes.length)return{summary:'No data',bias:'neutral',action_items:[]};
  const mx=Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  const king=strikes.reduce((b,s)=>(s.total_gamma||0)>(b.total_gamma||0)?s:b);
  const posA=strikes.filter(s=>s.strike>spot&&s.net_gex>mx*.15).sort((a,b)=>a.strike-b.strike);
  const posB=strikes.filter(s=>s.strike<spot&&s.net_gex>mx*.15).sort((a,b)=>b.strike-a.strike);
  const profile=total_net_gex>mx*.1?'positive':total_net_gex<-mx*.1?'negative':'neutral';
  const bias=profile==='positive'?'range':profile==='negative'?'trend':'chop';
  const kd=king.strike-spot;
  const items=[];
  if(Math.abs(kd/spot*100)>.02)items.push(`DRIFT: ${king.strike.toFixed(1)} (${kd>0?'above':'below'})`);
  else items.push(`PIN: ${king.strike.toFixed(1)}`);
  if(posB[0])items.push(`SUPPORT: ${posB[0].strike.toFixed(1)}`);
  if(posA[0])items.push(`RESISTANCE: ${posA[0].strike.toFixed(1)}`);
  const hi=posA[0]?.strike||(kd>0?king.strike:spot+20),lo=posB[0]?.strike||(kd<0?king.strike:spot-20);
  let summary;
  if(profile==='positive'&&Math.abs(kd/spot*100)<.15)summary=`PIN & CHOP ‚Äî King ${king.strike.toFixed(1)}. Fade ${lo.toFixed(1)}‚Äì${hi.toFixed(1)}.`;
  else if(profile==='positive')summary=`DRIFT TO KING ‚Äî Magnet ${king.strike.toFixed(1)}.`;
  else if(profile==='negative'&&kd>0)summary=`BULLISH MOMENTUM ‚Äî King UP to ${king.strike.toFixed(1)}.`;
  else if(profile==='negative'&&kd<0)summary=`BEARISH MOMENTUM ‚Äî King DOWN to ${king.strike.toFixed(1)}.`;
  else summary=`CHOPPY ‚Äî King ${king.strike.toFixed(1)}.`;
  return{summary,bias,king_node:{strike:king.strike},expected_range:{low:lo,high:hi},action_items:items};
}

function renderRecs(){
  const rw=document.getElementById('rw');if(!D){rw.classList.remove('vis');return}
  rw.innerHTML='';rw.classList.add('vis');
  getVisibleSyms().forEach(sym=>{
    const d=D[sym],r=d.recommendation||genRec(d);
    const spot=d.spot, strikes=d.strikes||[];
    const sorted=[...strikes].sort((a,b)=>a.strike-b.strike);
    const mx=Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
    const king=strikes.reduce((b,s)=>(s.total_gamma||Math.abs(s.net_gex))>(b.total_gamma||Math.abs(b.net_gex))?s:b,strikes[0]);
    const kingD=king?king.strike-spot:0;
    const kingPct=spot?((kingD/spot)*100).toFixed(2):0;
    const gw=d.gamma_wall||0, pw=d.put_wall||0;
    const net=d.total_net_gex||0;

    // Gamma profile
    const isNeg=net<-mx*.05, isPos=net>mx*.05;
    const gpClass=isNeg?'neg':isPos?'pos':'neu';
    const gpLabel=isNeg?'‚àíGamma (Momentum)':isPos?'+Gamma (Mean Revert)':'Neutral (Choppy)';

    // Bias
    const bias=r.bias||'chop';

    // Build rich commentary
    let commentary='';
    if(isNeg && kingD>0){
      commentary=`<strong>‚àíGamma + King above</strong> = dealers amplify upward moves. Expect <span class="hl">bullish momentum toward ${fp(king.strike)}</span>. Buy dips, don't fade. Debit call spreads favored.`;
    } else if(isNeg && kingD<0){
      commentary=`<strong>‚àíGamma + King below</strong> = dealers amplify downward moves. Expect <span class="hl">bearish momentum toward ${fp(king.strike)}</span>. Sell rips, buy put spreads. Do NOT sell premium here.`;
    } else if(isNeg && Math.abs(kingD)<spot*.001){
      commentary=`<strong>‚àíGamma + King at spot</strong> = explosive either direction. <span class="hl">Wait for break</span>, then ride momentum. Straddles or strangles if IV is low.`;
    } else if(isPos && Math.abs(kingD)<spot*.002){
      commentary=`<strong>+Gamma + King at spot</strong> = <span class="hl">pin & chop</span>. Dealers suppress moves both ways. Sell premium: iron condors, butterflies centered on ${fp(king.strike)}.`;
    } else if(isPos && kingD>0){
      commentary=`<strong>+Gamma + King above</strong> = slow grind up toward <span class="hl">${fp(king.strike)}</span>. Dealers dampen selloffs. Sell put spreads below, or drift-to-king butterflies.`;
    } else if(isPos && kingD<0){
      commentary=`<strong>+Gamma + King below</strong> = slow grind down toward <span class="hl">${fp(king.strike)}</span>. Dealers dampen rallies. Sell call spreads above, or drift-to-king butterflies.`;
    } else {
      commentary=`<strong>Mixed gamma</strong> ‚Äî no strong dealer bias. <span class="hl">Reduce size</span>, wait for clearer setup. King at ${fp(king?king.strike:0)}.`;
    }

    // Directional line
    const dirLine = kingD>0 
      ? `üëë King ${fp(king.strike)} ‚Äî ${Math.abs(kingD).toFixed(1)}pts <span style="color:var(--green)">above</span> spot (${kingPct}%). Drift target ‚Üë`
      : kingD<0
      ? `üëë King ${fp(king.strike)} ‚Äî ${Math.abs(kingD).toFixed(1)}pts <span style="color:var(--red)">below</span> spot (${kingPct}%). Drift target ‚Üì`
      : `üëë King ${fp(king.strike)} ‚Äî AT spot. Pin expected.`;

    // Support/resistance
    const posAbove=sorted.filter(s=>s.strike>spot&&s.net_gex>mx*.12).slice(0,1);
    const posBelow=sorted.filter(s=>s.strike<spot&&s.net_gex>mx*.12).reverse().slice(0,1);
    const resist=posAbove.length?fp(posAbove[0].strike):(gw?fp(gw):'‚Äî');
    const support=posBelow.length?fp(posBelow[0].strike):(pw?fp(pw):'‚Äî');

    const c=document.createElement('div');c.className=`rec ${bias}`;
    c.innerHTML=`<div class="rec-sym">${sym} $${fp(spot)} <span class="rec-badge ${bias}">${bias.toUpperCase()}</span></div>`+
      `<div class="rec-sum">${r.summary||''}</div>`+
      `<div class="rec-gamma ${gpClass}">${commentary}<br><span style="font-size:10px;color:var(--dim);margin-top:2px;display:inline-block">${dirLine}</span></div>`+
      `<div class="rec-lvls">`+
        `<span class="rec-lv king">üëë King: ${fp(king?king.strike:0)}</span>`+
        `<span class="rec-lv gp">${gpLabel}</span>`+
        `<span class="rec-lv" style="background:rgba(251,191,36,.08);color:var(--yellow);border:1px solid rgba(251,191,36,.15)">Sup: ${support}</span>`+
        `<span class="rec-lv" style="background:rgba(168,85,247,.08);color:var(--purple);border:1px solid rgba(168,85,247,.15)">Res: ${resist}</span>`+
      `</div>`;
    rw.appendChild(c);
  });
}

// ‚îÄ‚îÄ‚îÄ Heatmap panel ‚îÄ‚îÄ‚îÄ
function renderPanel(d){
  const{symbol,spot,strikes,total_net_gex,gamma_wall,put_wall}=d;
  const n=+document.getElementById('ns').value;
  const sorted=[...strikes].sort((a,b)=>a.strike-b.strike);
  if(!sorted.length)return document.createElement('div');
  const ci=sorted.reduce((b,s,i)=>Math.abs(s.strike-spot)<Math.abs(sorted[b].strike-spot)?i:b,0);
  const vis=sorted.slice(Math.max(0,ci-n),Math.min(sorted.length,ci+n+1)).reverse();
  const mx=Math.max(...vis.map(s=>Math.abs(s.net_gex)),1);
  const ss=sorted[ci]?.strike;
  const ks=vis.reduce((b,s)=>(s.total_gamma||Math.abs(s.net_gex))>(b.total_gamma||Math.abs(b.net_gex))?s:b).strike;
  const pc=total_net_gex>mx*.05?'pos':total_net_gex<-mx*.05?'neg':'neu';
  const pl=pc==='pos'?'+Gamma':pc==='neg'?'‚àíGamma':'Neutral';
  const pd=pc==='pos'?'Vol‚Üì Mean revert':pc==='neg'?'Vol‚Üë Momentum':'Choppy';
  const kingD=ks-spot,kingP=((kingD/spot)*100).toFixed(2);

  // Item 14: % day change for spot
  const openSnap=openingGEX[symbol];
  let dayChgHtml='';
  if(openSnap && openSnap._openSpot){
    const dayChg=((spot-openSnap._openSpot)/openSnap._openSpot*100);
    const sign=dayChg>=0?'+':'';
    const clr=dayChg>=0?'var(--green)':'var(--red)';
    dayChgHtml=`<span style="font-size:14px;color:${clr};margin-left:8px;font-weight:600">${sign}${dayChg.toFixed(2)}%</span>`;
  }

  const trackHtml = getTrackingHtml(symbol);

  const p=document.createElement('div');p.className='panel';
  p.innerHTML=`<div class="panel-hdr"><span class="panel-sym">${symbol}</span><span class="panel-price">$${fp(spot)}${dayChgHtml}</span></div>`+
    `<div class="panel-sub"><span>Net GEX: ${fg(total_net_gex)}</span><span>${d.expirations?d.expirations.length+' exp':''}</span></div>`+
    `<div class="panel-gp"><span class="gbadge ${pc}">${pl}</span><span style="font-size:11px;color:var(--dim)">${pd}</span></div>`+
    `<div class="klevels"><span class="klev kn">üëë ${fp(ks)}</span><span class="klev gw">Œì ${fp(gamma_wall)}</span><span class="klev pw">P ${fp(put_wall)}</span><span class="klev sp">‚óè ${fp(spot)}</span></div>`+
    `<div class="strikes" id="s-${symbol}"></div>`+
    `<div style="padding:4px 14px;font-size:11px;color:var(--king);border-top:1px solid var(--border);background:rgba(239,68,68,.03)">${kingD>0?'‚Üë':'‚Üì'} $${Math.abs(kingD).toFixed(2)} (${kingP}%) ${kingD>0?'above':'below'} spot</div>`+
    `${trackHtml}`;
  const cont=p.querySelector(`#s-${symbol}`);

  // Volume surge strikes to highlight
  const surgeStrikes = new Set((d.volume_surges||[]).map(v=>v.strike));

  vis.forEach(s=>{
    const iS=s.strike===ss,iK=s.strike===ks,iV=surgeStrikes.has(s.strike);
    const co=gc(s.net_gex,mx,iK);const tco=tc(s.net_gex,mx,iK);
    // Item 5: % change since open ‚Äî show NEXT TO strike label
    let chgTag='';
    if(openSnap){
      const openVal=openSnap[s.strike];
      if(openVal && Math.abs(openVal)>1000){
        const pctChg=((s.net_gex-openVal)/Math.abs(openVal))*100;
        if(Math.abs(pctChg)>=25){
          const sign=pctChg>0?'+':'';
          const clr=pctChg>0?'#4ade80':'#f87171';
          chgTag=` <span style="font-size:10px;color:${clr};font-weight:700">${sign}${pctChg.toFixed(0)}%</span>`;
        }
      }
    }
    // Item 10: bar width proportional to GEX magnitude, always from left
    const barPct=Math.max(5,Math.min(100,Math.round(Math.abs(s.net_gex)/mx*100)));

    // Item 11: King row styled via CSS .sr.king
    const row=document.createElement('div');
    row.className='sr'+(iS?' spot':'')+(iK?' king':'');
    if(iV) row.style.borderRight='3px solid var(--cyan)';

    row.innerHTML=`<div class="sr-bg" style="background:rgb(${co.r},${co.g},${co.b});width:${barPct}%;left:0"></div><span class="sr-lbl">${fp(s.strike)}${chgTag}</span><div class="gbar-c"><span class="gval" style="color:${tco}">${fg(s.net_gex)}${iK?' üëë':''}${iV?' üìà':''}</span></div>`;
    row.onmouseenter=e=>showTip(e,s,symbol,spot,mx,iK);row.onmousemove=moveTip;row.onmouseleave=hideTip;
    cont.appendChild(row);
  });
  return p;
}

function showTip(e,s,sym,spot,mx,iK){const t=document.getElementById('tip');const d=s.strike-spot,c=ct(s.net_gex,mx);document.getElementById('tt').textContent=(iK?'üëë ':'')+sym+' ‚Äî $'+fp(s.strike);document.getElementById('tb').innerHTML=`<div class="tip-r"><span class="tip-l">Net GEX</span><span class="tip-v">${fg(s.net_gex)}</span></div><div class="tip-r"><span class="tip-l">Call GEX</span><span class="tip-v" style="color:#fde68a">${fg(s.call_gex)}</span></div><div class="tip-r"><span class="tip-l">Put GEX</span><span class="tip-v" style="color:#d8b4fe">${fg(s.put_gex)}</span></div><div class="tip-d"></div><div class="tip-r"><span class="tip-l">Call OI</span><span class="tip-v">${(s.call_oi||0).toLocaleString()}</span></div><div class="tip-r"><span class="tip-l">Put OI</span><span class="tip-v">${(s.put_oi||0).toLocaleString()}</span></div><div class="tip-r"><span class="tip-l">Call Vol</span><span class="tip-v">${(s.call_volume||0).toLocaleString()}</span></div><div class="tip-r"><span class="tip-l">Put Vol</span><span class="tip-v">${(s.put_volume||0).toLocaleString()}</span></div>${s.call_bid?`<div class="tip-r"><span class="tip-l">Call Bid/Ask</span><span class="tip-v">$${s.call_bid.toFixed(2)}/$${s.call_ask.toFixed(2)}</span></div>`:''}${s.put_bid?`<div class="tip-r"><span class="tip-l">Put Bid/Ask</span><span class="tip-v">$${s.put_bid.toFixed(2)}/$${s.put_ask.toFixed(2)}</span></div>`:''}<div class="tip-r"><span class="tip-l">From Spot</span><span class="tip-v">${d>=0?'+':''}${d.toFixed(1)} (${((d/spot)*100).toFixed(2)}%)</span></div><div class="tip-d"></div><div class="tip-b">${bh(c,iK)}</div>`;t.classList.add('vis');moveTip(e)}
function moveTip(e){const t=document.getElementById('tip');const x=e.clientX+16,y=e.clientY-10;t.style.left=(x+t.offsetWidth>window.innerWidth?e.clientX-t.offsetWidth-16:x)+'px';t.style.top=(y+t.offsetHeight>window.innerHeight?window.innerHeight-t.offsetHeight-8:y)+'px'}
function hideTip(){document.getElementById('tip').classList.remove('vis')}

// ‚ïê‚ïê‚ïê IWM TOGGLE ‚ïê‚ïê‚ïê
let showIWM = false;
function toggleIWM(){
  showIWM = !showIWM;
  document.getElementById('iwmBtn').textContent = showIWM ? 'IWM: ON' : 'IWM: OFF';
  document.getElementById('iwmBtn').style.opacity = showIWM ? '1' : '0.5';
  rerender();
}

function getVisibleSyms(){
  if(!D) return [];
  return Object.keys(D).filter(s=> showIWM || s!=='IWM').sort((a,b)=>a==='SPX'?-1:b==='SPX'?1:0);
}

function rerender(){if(!D)return;renderRecs();if(stratVisible)renderStrats();const c=document.getElementById('hc');c.innerHTML='';
  getVisibleSyms().forEach(s=>c.appendChild(renderPanel(D[s])));updateTimestamp()}

function updateTimestamp(){
  const now=new Date();
  const local=now.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true});
  document.getElementById('st').textContent=local;
  updateMarketSession();
}

// ‚ïê‚ïê‚ïê MARKET SESSION INDICATOR ‚ïê‚ïê‚ïê
function updateMarketSession(){
  const now=new Date();
  const etStr=now.toLocaleString('en-US',{timeZone:'America/New_York',hour:'numeric',minute:'numeric',hour12:false});
  const [h,m]=etStr.split(':').map(Number);
  const mins=h*60+m;
  const el=document.getElementById('mktSession');
  const dow=new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'})).getDay();
  if(dow===0||dow===6){el.textContent='WEEKEND';el.className='market-session closed';return}
  if(mins>=240&&mins<570){el.textContent='PRE-MARKET';el.className='market-session pre'}
  else if(mins>=570&&mins<600){el.textContent='üîî OPENING';el.className='market-session open'}
  else if(mins>=600&&mins<900){el.textContent='MARKET OPEN';el.className='market-session open'}
  else if(mins>=900&&mins<960){el.textContent='‚ö° POWER HOUR';el.className='market-session power'}
  else if(mins>=960&&mins<1200){el.textContent='AFTER HOURS';el.className='market-session closed'}
  else{el.textContent='CLOSED';el.className='market-session closed'}
}

// ‚ïê‚ïê‚ïê COUNTDOWN TIMER ‚ïê‚ïê‚ïê
const FETCH_INTERVAL_MS = 5*60*1000;
let lastFetchTime = null;
let countdownInterval = null;
function startCountdown(){
  if(countdownInterval)clearInterval(countdownInterval);
  lastFetchTime=Date.now();
  countdownInterval=setInterval(()=>{
    const elapsed=Date.now()-lastFetchTime;
    const remaining=Math.max(0,FETCH_INTERVAL_MS-elapsed);
    const secs=Math.ceil(remaining/1000);
    const mm=Math.floor(secs/60),ss=secs%60;
    const el=document.getElementById('countdown');
    if(remaining<=0){el.textContent='Updating...'}
    else{el.textContent=`Next update in ${mm}:${ss.toString().padStart(2,'0')}`}
  },1000);
}

// ‚ïê‚ïê‚ïê COLOR GUIDE TOGGLE ‚ïê‚ïê‚ïê
function toggleColorGuide(){
  const d=document.getElementById('legend-detail');
  d.style.display=d.style.display==='none'?'block':'none';
}

// ‚ïê‚ïê‚ïê AUTO-RELOAD ‚ïê‚ïê‚ïê
let autoFile=null,autoInterval=null;
function loadFile(e){const f=e.target.files[0];if(!f)return;autoFile=f;readAndRender(f);startAutoReload()}
function readAndRender(f){const r=new FileReader();r.onload=ev=>{try{const nd=JSON.parse(ev.target.result);const nt=nd[Object.keys(nd)[0]]?.timestamp;const ot=D?.[Object.keys(D||{})[0]]?.timestamp;if(nt!==ot||!D){D=nd;document.getElementById('sb').classList.remove('vis');document.getElementById('sd').className='status-dot live';rerender()}}catch(e){console.error(e)}};r.readAsText(f)}
function startAutoReload(){if(autoInterval)clearInterval(autoInterval);autoInterval=setInterval(()=>{if(autoFile)readAndRender(autoFile)},30000);document.getElementById('st').textContent='Auto-reload ON (30s)'}
function stopAutoReload(){if(autoInterval){clearInterval(autoInterval);autoInterval=null}document.getElementById('st').textContent='Auto-reload OFF'}

function loadSample(){
  const sp={SPX:6974,SPY:695,QQQ:615,IWM:267};D={};
  Object.keys(sp).forEach(sym=>{
    const spot=sp[sym]*(1+(Math.random()-.5)*.002),step=sym==='SPX'?5:1;
    const strikes=[],center=Math.round(spot/step)*step;
    const scale=sym==='SPX'?1:sym==='SPY'?8:sym==='QQQ'?1.5:0.4;
    for(let i=-25;i<=25;i++){
      const strike=center+i*step;let net;const decay=Math.exp(-Math.abs(i)*.07);
      if(Math.abs(i)<=1)net=(Math.random()-.4)*15e3*scale;
      else if(i>0){net=12e3*(.05+Math.random()*.5)*decay*scale;if(strike%(step*10)===0)net*=2.5+Math.random()*2}
      else{net=-12e3*(.05+Math.random()*.5)*decay*scale;if(strike%(step*10)===0)net*=2.5+Math.random()*2}
      if(i===-1)net=35e3*scale;
      const cg=Math.abs(net)*(.5+Math.random()*.4),pg=Math.abs(net)*(.3+Math.random()*.3);
      strikes.push({strike,net_gex:net,call_gex:net>0?cg:cg*.3,put_gex:net<0?-pg:-pg*.2,total_gamma:cg+pg,call_oi:~~(Math.random()*12e3+100),put_oi:~~(Math.random()*12e3+100),call_volume:~~(Math.random()*5e3),put_volume:~~(Math.random()*5e3),call_bid:Math.max(0,(20-Math.abs(i)*1.2)+Math.random()*2)*1,call_ask:Math.max(.05,(20-Math.abs(i)*1.1)+Math.random()*3)*1,put_bid:Math.max(0,(15-Math.abs(i)*1)+Math.random()*2)*1,put_ask:Math.max(.05,(15-Math.abs(i)*.9)+Math.random()*3)*1,call_iv:18+Math.random()*8,put_iv:20+Math.random()*10,call_delta:Math.max(0,.5-i*.03),put_delta:Math.min(0,-.5-i*.03)})
    }
    strikes.sort((a,b)=>a.strike-b.strike);
    const tot=strikes.reduce((s,x)=>s+x.net_gex,0);
    // Simulate king history ‚Äî king moved from +10pts to current
    const origKing=center+step*2;
    const kingNow=strikes.reduce((b,s)=>s.total_gamma>b.total_gamma?s:b);
    const now=new Date();
    D[sym]={symbol:sym,spot,timestamp:now.toISOString(),expirations:['2026-02-11'],total_net_gex:tot,
      gamma_wall:strikes.reduce((b,s)=>s.net_gex>b.net_gex?s:b).strike,
      put_wall:strikes.reduce((b,s)=>s.net_gex<b.net_gex?s:b).strike,
      king_node:kingNow.strike,strikes,
      king_history:[
        {strike:origKing,timestamp:new Date(now-2*3600000).toISOString(),spot:spot+5},
        {strike:origKing-step,timestamp:new Date(now-3600000).toISOString(),spot:spot+2},
        {strike:kingNow.strike,timestamp:now.toISOString(),spot},
      ],
      volume_surges:[
        {strike:center-step*3,prev_vol:800,curr_vol:2400,delta:1600,pct:200,call_vol:1200,put_vol:1200},
        {strike:center+step*5,prev_vol:500,curr_vol:1100,delta:600,pct:120,call_vol:900,put_vol:200},
      ],
    }
  });
  document.getElementById('sb').classList.add('vis');document.getElementById('sd').className='status-dot live';document.getElementById('st').textContent='Sample (0DTE)';rerender()
}
// ‚ïê‚ïê‚ïê SERVER AUTO-FETCH (every 5 min) ‚ïê‚ïê‚ïê
let serverInterval = null;
let fetchAttempts = 0;
async function fetchFromServer() {
  try {
    const resp = await fetch('/api/gex');
    if (!resp.ok) {
      fetchAttempts++;
      if (fetchAttempts <= 2) document.getElementById('st').textContent = `Server error (${resp.status}) ‚Äî retrying...`;
      return;
    }
    const newD = await resp.json();
    if (newD && Object.keys(newD).length > 0) {
      const newTs = newD[Object.keys(newD)[0]]?.timestamp;
      const oldTs = D?.[Object.keys(D||{})[0]]?.timestamp;
      if (newTs !== oldTs || !D) {
        D = newD;
        // Save opening GEX snapshot (first fetch of day = baseline for % change)
        if(Object.keys(openingGEX).length===0){
          Object.keys(newD).forEach(sym=>{
            openingGEX[sym]={_openSpot:newD[sym].spot};
            (newD[sym].strikes||[]).forEach(s=>{openingGEX[sym][s.strike]=s.net_gex});
          });
        }
        document.getElementById('sb').classList.remove('vis');
        document.getElementById('sd').className = 'status-dot live';
        rerender();
        startCountdown();
        fetchAttempts = 0;
      }
    } else {
      fetchAttempts++;
      if (!D) {
        document.getElementById('st').textContent = 'Waiting for data (market may be closed)';
        document.getElementById('hc').innerHTML = '<div class="empty"><h2>Waiting for Market Data</h2><p>The fetcher is running but market may be closed. Data will appear automatically when available.</p><p style="margin-top:8px;font-size:11px;color:var(--dim)">Or click <code>üß™ Sample</code> to preview with demo data.</p></div>';
      }
    }
  } catch(e) {
    fetchAttempts++;
    if (fetchAttempts <= 2) document.getElementById('st').textContent = 'Connecting to server...';
    else document.getElementById('st').textContent = 'Server unreachable ‚Äî use üìÇ Load JSON';
    // Show Load JSON button as fallback after repeated failures
    if (fetchAttempts >= 3) document.querySelectorAll('.localOnly').forEach(el => el.style.display = 'flex');
  }
}

function startServerFetch() {
  fetchFromServer();
  if (serverInterval) clearInterval(serverInterval);
  serverInterval = setInterval(fetchFromServer, 5 * 60 * 1000);
  document.getElementById('st').textContent = 'Connecting...';
}

// ‚ïê‚ïê‚ïê MODE DETECTION ‚ïê‚ïê‚ïê
updateMarketSession();
setInterval(updateMarketSession, 60000);
if (window.location.protocol !== 'file:') {
  // Only auto-fetch if already authenticated (session restored)
  if(sessionStorage.getItem('gex_auth')==='1') startServerFetch();
} else {
  document.querySelectorAll('.localOnly').forEach(el => el.style.display = 'flex');
}
</script>
</body></html>
