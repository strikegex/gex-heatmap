<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StrikeGEX ‚Äî GEX Live</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a12;--panel:#0e0e18;--card:#13131f;--border:#1a1a2e;--text:#b0b0c8;--dim:#4a4a68;--bright:#e8e8f4;--green:#00c853;--red:#ff1744;--cyan:#00bcd4;--yellow:#ffd600;--purple:#aa00ff;--accent:#536dfe;--king:#ff5252;--hvl:#00e5ff;--spot:#ffffff}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê */
.topbar{display:flex;align-items:center;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--panel);gap:16px;flex-shrink:0}
.logo-area{display:flex;align-items:center;gap:8px}
.logo-area img{width:28px;height:28px;border-radius:6px}
.sym-info{display:flex;align-items:center;gap:12px}
.sym-name{font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700;color:var(--bright)}
.sym-price{font-size:16px;font-weight:600;color:var(--bright)}
.sym-chg{font-size:12px;font-weight:600;padding:2px 6px;border-radius:3px}
.sym-chg.up{background:rgba(0,200,83,.12);color:var(--green)}
.sym-chg.dn{background:rgba(255,23,68,.12);color:var(--red)}
.ivr-badge{font-size:10px;padding:2px 8px;border-radius:3px;font-weight:600;background:rgba(0,188,212,.15);color:var(--cyan);border:1px solid rgba(0,188,212,.3)}
.time-area{display:flex;gap:20px;margin-left:auto;align-items:center}
.time-box{text-align:center}
.time-label{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.time-val{font-size:12px;color:var(--text);font-weight:500}
.refresh-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ‚ïê‚ïê‚ïê EXPIRY TABS ‚ïê‚ïê‚ïê */
.expiry-bar{display:flex;align-items:center;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--panel);gap:6px;flex-shrink:0;overflow-x:auto}
.exp-tab{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--dim);transition:all .15s;white-space:nowrap}
.exp-tab:hover{border-color:var(--accent);color:var(--text)}
.exp-tab.active{background:var(--accent);border-color:var(--accent);color:#fff}
.exp-tab .dte{font-size:9px;opacity:.7;margin-left:4px}

/* ‚ïê‚ïê‚ïê SYMBOL SELECTOR ‚ïê‚ïê‚ïê */
.sym-tabs{display:flex;gap:4px;margin-right:auto}
.sym-tab{padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;background:rgba(255,255,255,.03);color:var(--dim);border:1px solid transparent;transition:all .15s}
.sym-tab:hover{color:var(--text);border-color:var(--border)}
.sym-tab.active{background:rgba(83,109,254,.12);color:var(--accent);border-color:rgba(83,109,254,.3)}

/* ‚ïê‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê‚ïê */
.main{flex:1;display:flex;overflow:hidden}
.chart-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.sidebar{width:320px;border-left:1px solid var(--border);background:var(--panel);overflow-y:auto;flex-shrink:0}

/* ‚ïê‚ïê‚ïê COLUMN HEADERS ‚ïê‚ïê‚ïê */
.col-hdr{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);background:var(--card);font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;flex-shrink:0}
.col-hdr .col-strike{width:60px;text-align:center}
.col-hdr .col-gex{flex:1;text-align:center}
.col-hdr .col-netoi{width:70px;text-align:center}
.col-hdr .col-netvol{width:70px;text-align:center}
.col-hdr .col-strike-r{width:60px;text-align:center}

/* ‚ïê‚ïê‚ïê STRIKE ROWS ‚ïê‚ïê‚ïê */
.rows-wrap{flex:1;overflow-y:auto;position:relative}
.row{display:flex;align-items:center;height:24px;position:relative;border-bottom:1px solid rgba(255,255,255,.02)}
.row:hover{background:rgba(255,255,255,.03)}
.row.is-spot{background:rgba(255,255,255,.06)}
.row.is-hvl{background:rgba(0,229,255,.04)}
.row.is-king{background:rgba(255,82,82,.04)}

/* Strike labels */
.strike-l,.strike-r{width:60px;font-size:11px;text-align:center;color:var(--dim);flex-shrink:0;position:relative;z-index:2}
.row.is-spot .strike-l,.row.is-spot .strike-r{color:var(--spot);font-weight:700}
.row.is-king .strike-l,.row.is-king .strike-r{color:var(--king);font-weight:700}

/* GEX bar area ‚Äî centered */
.gex-bar-area{flex:1;height:100%;display:flex;position:relative;overflow:hidden}
.gex-center{position:absolute;left:50%;top:0;bottom:0;width:1px;background:rgba(255,255,255,.08);z-index:1}
.gex-bar{position:absolute;top:2px;bottom:2px;z-index:2;border-radius:1px;min-width:1px}
.gex-bar.pos{background:var(--green);right:50%;border-radius:1px 0 0 1px}
.gex-bar.neg{background:var(--red);left:50%;border-radius:0 1px 1px 0}

/* OI / Vol columns */
.col-oi,.col-vol{width:70px;font-size:9px;text-align:right;padding-right:8px;flex-shrink:0;position:relative;z-index:2}

/* Level markers on left side */
.level-tag{position:absolute;left:0;z-index:10;font-size:9px;font-weight:700;padding:1px 6px;border-radius:0 3px 3px 0;white-space:nowrap}
.level-tag.ps{background:var(--red);color:#fff}
.level-tag.cr{background:var(--green);color:#fff}
.level-tag.hvl{background:var(--hvl);color:#000}
.level-tag.ct{background:rgba(0,200,83,.6);color:#fff}
.level-tag.pt{background:rgba(255,23,68,.6);color:#fff}
.level-tag.spot{background:var(--spot);color:#000}
.level-tag.king{background:var(--king);color:#fff}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sb-section{padding:14px 16px;border-bottom:1px solid var(--border)}
.sb-title{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.gamma-profile{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.gp-dot{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px}
.gp-dot.pos{background:rgba(0,200,83,.15);color:var(--green)}
.gp-dot.neg{background:rgba(255,23,68,.15);color:var(--red)}
.gp-dot.neu{background:rgba(255,214,0,.15);color:var(--yellow)}
.gp-label{font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700}
.gp-label.pos{color:var(--green)}
.gp-label.neg{color:var(--red)}
.gp-label.neu{color:var(--yellow)}
.gp-desc{font-size:10px;color:var(--dim);margin-bottom:12px}

/* Key levels */
.kl-row{display:flex;align-items:center;padding:4px 0;font-size:11px}
.kl-dot{width:8px;height:8px;border-radius:50%;margin-right:8px;flex-shrink:0}
.kl-name{flex:1;color:var(--text)}
.kl-price{font-weight:600;color:var(--bright);margin-right:8px}
.kl-pct{font-size:10px;font-weight:600}
.kl-pct.above{color:var(--green)}
.kl-pct.below{color:var(--red)}

/* GEX/DEX stats */
.stats-row{display:flex;gap:8px;margin-bottom:8px}
.stat-box{flex:1;text-align:center}
.stat-label{font-size:8px;color:var(--dim);text-transform:uppercase}
.stat-val{font-size:16px;font-weight:700;color:var(--bright)}
.stat-val.pos{color:var(--green)}
.stat-val.neg{color:var(--red)}
.stat-chg{font-size:9px;padding:2px 6px;border-radius:3px;display:inline-block;margin-top:2px}
.stat-chg.pos{background:rgba(0,200,83,.12);color:var(--green)}
.stat-chg.neg{background:rgba(255,23,68,.12);color:var(--red)}

/* Chain activity */
.chain-meter{height:6px;border-radius:3px;background:var(--border);overflow:hidden;margin:8px 0}
.chain-fill{height:100%;border-radius:3px;transition:width .3s}
.chain-fill.puts{background:var(--red)}
.chain-fill.calls{background:var(--green)}
.chain-labels{display:flex;justify-content:space-between;font-size:9px}

/* Vol/OI bars */
.voibar{display:flex;align-items:center;gap:4px;margin:4px 0}
.voibar-label{width:60px;font-size:9px;color:var(--dim)}
.voibar-track{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;display:flex}
.voibar-call{height:100%;background:var(--green);border-radius:4px 0 0 4px}
.voibar-put{height:100%;background:var(--red);border-radius:0 4px 4px 0}
.voibar-vals{display:flex;justify-content:space-between;font-size:9px;margin-top:2px}

/* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center}
.login-overlay.hidden{display:none}
.login-box{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:40px 36px;width:340px;text-align:center}
.login-box h2{font-family:'Space Grotesk',sans-serif;font-size:20px;color:var(--bright);margin-bottom:6px}
.login-box h2 em{font-style:normal;color:var(--accent)}
.login-box p{font-size:11px;color:var(--dim);margin-bottom:24px}
.login-box input{width:100%;padding:10px 14px;margin-bottom:12px;font-family:'JetBrains Mono',monospace;font-size:13px;background:var(--card);color:var(--bright);border:1px solid var(--border);border-radius:6px;outline:none}
.login-box input:focus{border-color:var(--accent)}
.login-box .login-btn{width:100%;padding:10px;font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:600;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer}
.login-box .login-btn:hover{opacity:.85}
.login-box .login-err{font-size:11px;color:var(--red);margin-top:8px;display:none}

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
.footer{padding:6px 16px;border-top:1px solid var(--border);background:var(--panel);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;font-size:9px;color:var(--dim)}
.footer a{color:var(--dim);text-decoration:none;margin-left:12px}
.footer a:hover{color:var(--text)}

/* Mobile */
@media(max-width:900px){
  .sidebar{display:none}
  .col-oi,.col-vol,.col-hdr .col-netoi,.col-hdr .col-netvol{display:none}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2><em>Strike</em>GEX</h2>
    <p>GEX Live ‚Äî Restricted Access</p>
    <input type="text" id="loginUser" placeholder="Username" autocomplete="username">
    <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="loginErr">Invalid credentials</div>
  </div>
</div>

<div id="appWrap" style="display:none">

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo-area">
    <img src="/static/logo.png" alt="SG" onerror="this.style.display='none'" style="border-radius:6px">
    <span style="font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:700;color:var(--bright)"><em style="color:var(--accent);font-style:normal">Strike</em>GEX</span>
  </div>
  <div class="sym-tabs" id="symTabs"></div>
  <div class="sym-info" id="symInfo"></div>
  <div class="time-area">
    <div class="time-box"><div class="time-label">New York</div><div class="time-val" id="etTime">‚Äî</div></div>
    <div class="time-box"><div class="time-label">Your Time</div><div class="time-val" id="localTime">‚Äî</div></div>
    <div class="time-box"><div class="time-label">Last Refresh</div><div class="time-val" id="lastRefresh">‚Äî</div></div>
    <div class="refresh-dot" id="refreshDot"></div>
  </div>
</div>

<!-- EXPIRY TABS (placeholder ‚Äî we only have 0DTE data currently) -->
<div class="expiry-bar" id="expiryBar">
  <div class="exp-tab active">0DTE</div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="chart-area">
    <!-- Column headers -->
    <div class="col-hdr">
      <div class="col-strike">STRIKE</div>
      <div class="col-gex">NET GEX</div>
      <div class="col-netoi">Net OI</div>
      <div class="col-netvol">Net Vol</div>
      <div class="col-strike-r">STRIKE</div>
    </div>
    <!-- Rows -->
    <div class="rows-wrap" id="rowsWrap"></div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="sidebar" id="sidebar"></div>
</div>

<!-- FOOTER -->
<div class="footer">
  <span>¬© 2025 StrikeGEX ‚Äî Gamma Exposure Intelligence</span>
  <span>
    <a href="https://x.com/strikegex" target="_blank">ùïè Follow</a>
    <a href="https://discord.gg" target="_blank">Discord</a>
    <a href="/">Heatmap View</a>
  </span>
</div>

</div><!-- end appWrap -->

<script>
// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
function doLogin(){
  const u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value;
  const err=document.getElementById('loginErr');err.style.display='none';
  fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})})
    .then(r=>r.json()).then(d=>{
      if(d.ok){sessionStorage.setItem('gex_auth','1');document.getElementById('loginOverlay').classList.add('hidden');document.getElementById('appWrap').style.display='';startFetch()}
      else{err.textContent=d.error||'Invalid credentials';err.style.display='block'}
    }).catch(()=>{
      if(u==='admin'&&p==='strikegex'){sessionStorage.setItem('gex_auth','1');document.getElementById('loginOverlay').classList.add('hidden');document.getElementById('appWrap').style.display=''}
      else{err.textContent='Invalid credentials';err.style.display='block'}
    });
}
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
if(sessionStorage.getItem('gex_auth')==='1'){document.getElementById('loginOverlay').classList.add('hidden');document.getElementById('appWrap').style.display=''}

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let D=null, activeSym='SPX', FETCH_INT=60;

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
const fp=v=>{const a=Math.abs(v);return a>=1e6?(v/1e6).toFixed(2)+'M':a>=1e3?(v/1e3).toFixed(1)+'K':v.toFixed(1)};
const fpm=v=>v.toFixed(2);
const fk=v=>{const a=Math.abs(v);return a>=1e6?(v/1e6).toFixed(2)+'M':a>=1e3?(v/1e3).toFixed(1)+'K':v.toFixed(0)};

// ‚ïê‚ïê‚ïê CLOCKS ‚ïê‚ïê‚ïê
function updateClocks(){
  const now=new Date();
  document.getElementById('localTime').textContent=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById('etTime').textContent=now.toLocaleTimeString('en-US',{timeZone:'America/New_York',hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
setInterval(updateClocks,1000);updateClocks();

// ‚ïê‚ïê‚ïê RENDER SYMBOL TABS ‚ïê‚ïê‚ïê
function renderSymTabs(){
  const c=document.getElementById('symTabs');c.innerHTML='';
  if(!D)return;
  Object.keys(D).forEach(sym=>{
    const t=document.createElement('div');t.className='sym-tab'+(sym===activeSym?' active':'');
    t.textContent=sym;t.onclick=()=>{activeSym=sym;renderSymTabs();render()};
    c.appendChild(t);
  });
}

// ‚ïê‚ïê‚ïê COMPUTE KEY LEVELS ‚ïê‚ïê‚ïê
function computeLevels(d){
  const{spot,strikes,total_net_gex,gamma_wall,put_wall}=d;
  const sorted=[...strikes].sort((a,b)=>b.net_gex-a.net_gex);
  const mx=Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  const king=strikes.reduce((b,s)=>Math.abs(s.net_gex)>Math.abs(b.net_gex)?s:b,strikes[0]);

  // HVL: gamma flip point ‚Äî where cumulative GEX crosses zero
  const byStrike=[...strikes].sort((a,b)=>a.strike-b.strike);
  let cumGex=0,hvl=spot;
  for(let i=0;i<byStrike.length-1;i++){
    cumGex+=byStrike[i].net_gex;
    if(i>0){
      const prev=cumGex-byStrike[i].net_gex;
      if((prev>=0&&cumGex<0)||(prev<=0&&cumGex>0)){
        hvl=byStrike[i].strike;break;
      }
    }
  }

  // Call Resistance: highest +GEX strike above spot
  const callWalls=byStrike.filter(s=>s.strike>spot&&s.net_gex>mx*.1).sort((a,b)=>b.net_gex-a.net_gex);
  const cr=callWalls[0]?.strike||gamma_wall;

  // Put Support: highest -GEX (or +GEX) strike below spot
  const putWalls=byStrike.filter(s=>s.strike<spot&&s.net_gex>mx*.1).sort((a,b)=>b.net_gex-a.net_gex);
  const ps=putWalls[0]?.strike||put_wall;

  // Transitions
  const ct=callWalls[1]?.strike||(cr?cr-5:spot+10);
  const pt=putWalls[1]?.strike||(ps?ps+5:spot-10);

  // Gamma profile
  const profile=total_net_gex>mx*.05?'positive':total_net_gex<-mx*.05?'negative':'neutral';
  const aboveHvl=spot>hvl;
  let profileLabel,profileDesc;
  if(profile==='positive'){
    profileLabel=aboveHvl?'Positive Squeeze':'Positive Expansion';
    profileDesc=aboveHvl?'Above CR ‚Üí positive gamma squeeze':'Below HVL ‚Üí dealers amplify moves';
  }else if(profile==='negative'){
    profileLabel=aboveHvl?'Negative Squeeze':'Negative Expansion';
    profileDesc=aboveHvl?'Above HVL ‚Üí negative gamma squeeze':'Below HVL ‚Üí negative expansion';
  }else{
    profileLabel='Neutral';profileDesc='Mixed gamma positioning';
  }

  // Total volume/OI
  const totalCallVol=strikes.reduce((s,x)=>s+(x.call_volume||0),0);
  const totalPutVol=strikes.reduce((s,x)=>s+(x.put_volume||0),0);
  const totalCallOI=strikes.reduce((s,x)=>s+(x.call_oi||0),0);
  const totalPutOI=strikes.reduce((s,x)=>s+(x.put_oi||0),0);
  const putCallRatio=totalCallVol>0?totalPutVol/totalCallVol:0;

  return{king,hvl,cr,ps,ct,pt,profile,profileLabel,profileDesc,spot,
    totalCallVol,totalPutVol,totalCallOI,totalPutOI,putCallRatio,total_net_gex,mx};
}

// ‚ïê‚ïê‚ïê MAIN RENDER ‚ïê‚ïê‚ïê
function render(){
  if(!D||!D[activeSym])return;
  const d=D[activeSym];
  const{spot,strikes}=d;
  const levels=computeLevels(d);

  // Symbol info bar
  document.getElementById('symInfo').innerHTML=
    `<span class="sym-name">${activeSym}</span>`+
    `<span class="sym-price">$${fpm(spot)}</span>`;

  // Render rows
  const wrap=document.getElementById('rowsWrap');wrap.innerHTML='';
  const byStrike=[...strikes].sort((a,b)=>b.strike-a.strike);
  const mx=Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  const nearSpot=strikes.reduce((b,s)=>Math.abs(s.strike-spot)<Math.abs(b.strike-spot)?s:b);

  byStrike.forEach(s=>{
    const row=document.createElement('div');row.className='row';
    const isSpot=s.strike===nearSpot.strike;
    const isKing=s.strike===levels.king.strike;
    const isHvl=Math.abs(s.strike-levels.hvl)<0.5;
    if(isSpot)row.classList.add('is-spot');
    if(isKing)row.classList.add('is-king');
    if(isHvl)row.classList.add('is-hvl');

    // Bar width: percentage of max
    const pct=Math.max(1,Math.abs(s.net_gex)/mx*45); // 45% max from center
    const isPos=s.net_gex>=0;

    // Net OI = call_oi - put_oi
    const netOI=(s.call_oi||0)-(s.put_oi||0);
    const netVol=(s.call_volume||0)-(s.put_volume||0);

    // Level tags
    let tags='';
    if(isSpot)tags+=`<span class="level-tag spot">‚óè ${fpm(spot)}</span>`;
    if(isKing)tags+=`<span class="level-tag king">üëë KING</span>`;
    if(isHvl)tags+=`<span class="level-tag hvl">HVL ${s.strike.toFixed(1)}</span>`;
    if(Math.abs(s.strike-levels.cr)<0.5)tags+=`<span class="level-tag cr">CR ${s.strike.toFixed(1)}</span>`;
    if(Math.abs(s.strike-levels.ps)<0.5)tags+=`<span class="level-tag ps">PS ${s.strike.toFixed(1)}</span>`;

    row.innerHTML=
      `<div class="strike-l">${s.strike.toFixed(s.strike%1?1:0)}</div>`+
      `<div class="gex-bar-area">`+
        `<div class="gex-center"></div>`+
        `<div class="gex-bar ${isPos?'pos':'neg'}" style="width:${pct}%"></div>`+
        `${tags}`+
      `</div>`+
      `<div class="col-oi" style="color:${netOI>=0?'var(--green)':'var(--red)'}">${fk(netOI)}</div>`+
      `<div class="col-vol" style="color:${netVol>=0?'var(--green)':'var(--red)'}">${fk(netVol)}</div>`+
      `<div class="strike-r">${s.strike.toFixed(s.strike%1?1:0)}</div>`;

    // Scroll into view if spot
    if(isSpot)setTimeout(()=>row.scrollIntoView({block:'center'}),100);
    wrap.appendChild(row);
  });

  // Render sidebar
  renderSidebar(d,levels);
}

// ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê
function renderSidebar(d,lv){
  const sb=document.getElementById('sidebar');
  const spot=d.spot;
  const pctFrom=(val)=>{const p=((val-spot)/spot*100);return{val:p,cls:p>=0?'above':'below',txt:(p>=0?'+':'')+p.toFixed(2)+'%'}};

  const gpCls=lv.profile==='positive'?'pos':lv.profile==='negative'?'neg':'neu';

  sb.innerHTML=
    // GEX / DEX stats
    `<div class="sb-section">`+
      `<div class="stats-row">`+
        `<div class="stat-box"><div class="stat-label">GEX</div><div class="stat-val ${lv.total_net_gex>=0?'pos':'neg'}">${fp(lv.total_net_gex)}</div></div>`+
        `<div class="stat-box"><div class="stat-label">Net OI</div><div class="stat-val">${fk(lv.totalCallOI-lv.totalPutOI)}</div></div>`+
      `</div>`+
    `</div>`+

    // Gamma Profile
    `<div class="sb-section">`+
      `<div class="sb-title">Gamma Profile</div>`+
      `<div class="gamma-profile">`+
        `<div class="gp-dot ${gpCls}">${gpCls==='pos'?'+':gpCls==='neg'?'‚àí':'‚óã'}</div>`+
        `<div class="gp-label ${gpCls}">${lv.profileLabel}</div>`+
      `</div>`+
      `<div class="gp-desc">${lv.profileDesc}</div>`+
    `</div>`+

    // Key Levels
    `<div class="sb-section">`+
      `<div class="sb-title">Key GEX Levels</div>`+
      `<div class="kl-row"><div class="kl-dot" style="background:var(--red)"></div><div class="kl-name">PS</div><div class="kl-price">${lv.ps?.toFixed(1)||'‚Äî'}</div><div class="kl-pct ${pctFrom(lv.ps).cls}">${pctFrom(lv.ps).txt}</div></div>`+
      `<div class="kl-row"><div class="kl-dot" style="background:var(--dim)"></div><div class="kl-name">${activeSym}</div><div class="kl-price">$${fpm(spot)}</div><div class="kl-pct" style="color:var(--dim)">spot</div></div>`+
      `<div class="kl-row"><div class="kl-dot" style="background:var(--green)"></div><div class="kl-name">CR</div><div class="kl-price">${lv.cr?.toFixed(1)||'‚Äî'}</div><div class="kl-pct ${pctFrom(lv.cr).cls}">${pctFrom(lv.cr).txt}</div></div>`+
      `<div class="kl-row"><div class="kl-dot" style="background:rgba(0,200,83,.6)"></div><div class="kl-name">cTrans</div><div class="kl-price">${lv.ct?.toFixed(1)||'‚Äî'}</div><div class="kl-pct ${pctFrom(lv.ct).cls}">${pctFrom(lv.ct).txt}</div></div>`+
      `<div class="kl-row"><div class="kl-dot" style="background:var(--hvl)"></div><div class="kl-name">HVL</div><div class="kl-price">${lv.hvl?.toFixed(1)||'‚Äî'}</div><div class="kl-pct ${pctFrom(lv.hvl).cls}">${pctFrom(lv.hvl).txt}</div></div>`+
      `<div class="kl-row"><div class="kl-dot" style="background:rgba(255,23,68,.6)"></div><div class="kl-name">pTrans</div><div class="kl-price">${lv.pt?.toFixed(1)||'‚Äî'}</div><div class="kl-pct ${pctFrom(lv.pt).cls}">${pctFrom(lv.pt).txt}</div></div>`+
      `<div class="kl-row"><div class="kl-dot" style="background:var(--king)"></div><div class="kl-name">üëë King</div><div class="kl-price">${lv.king.strike.toFixed(1)}</div><div class="kl-pct ${pctFrom(lv.king.strike).cls}">${pctFrom(lv.king.strike).txt}</div></div>`+
    `</div>`+

    // Chain Activity
    `<div class="sb-section">`+
      `<div class="sb-title">Chain Activity</div>`+
      `<div style="text-align:center;font-size:14px;font-weight:700;color:${lv.totalPutVol>lv.totalCallVol?'var(--red)':'var(--green)'};margin-bottom:4px">${lv.totalPutVol>lv.totalCallVol?'PUTS':'CALLS'}</div>`+
      `<div style="text-align:center;font-size:9px;color:var(--dim);margin-bottom:6px">Vol/OI ‚Üí</div>`+
      `<div class="chain-meter"><div class="chain-fill puts" style="width:${Math.round(lv.totalPutVol/(lv.totalPutVol+lv.totalCallVol)*100)}%"></div></div>`+
      `<div class="chain-labels"><span style="color:var(--red)">PUTS</span><span style="color:var(--dim)">BALANCED</span><span style="color:var(--green)">CALLS</span></div>`+
    `</div>`+

    // Volume
    `<div class="sb-section">`+
      `<div class="sb-title">Volume</div>`+
      `<div class="voibar"><div class="voibar-label">VOL</div><div class="voibar-track"><div class="voibar-call" style="width:${Math.round(lv.totalCallVol/(lv.totalCallVol+lv.totalPutVol)*100)}%"></div><div class="voibar-put" style="width:${Math.round(lv.totalPutVol/(lv.totalCallVol+lv.totalPutVol)*100)}%"></div></div></div>`+
      `<div class="voibar-vals"><span style="color:var(--green)">${fk(lv.totalCallVol)} Call</span><span style="color:var(--red)">${fk(lv.totalPutVol)} Put</span></div>`+
      `<div class="voibar" style="margin-top:8px"><div class="voibar-label">OI</div><div class="voibar-track"><div class="voibar-call" style="width:${Math.round(lv.totalCallOI/(lv.totalCallOI+lv.totalPutOI)*100)}%"></div><div class="voibar-put" style="width:${Math.round(lv.totalPutOI/(lv.totalCallOI+lv.totalPutOI)*100)}%"></div></div></div>`+
      `<div class="voibar-vals"><span style="color:var(--green)">${fk(lv.totalCallOI)} Call</span><span style="color:var(--red)">${fk(lv.totalPutOI)} Put</span></div>`+
    `</div>`;
}

// ‚ïê‚ïê‚ïê DATA FETCH ‚ïê‚ïê‚ïê
let fetchTimer=null;
function startFetch(){
  async function doFetch(){
    try{
      const r=await fetch('/api/gex');
      if(r.ok){
        const newD=await r.json();
        if(newD&&Object.keys(newD).length){
          D=newD;
          document.getElementById('lastRefresh').textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
          document.getElementById('refreshDot').style.background='var(--green)';
          renderSymTabs();render();
        }
      }
    }catch(e){console.error('Fetch:',e)}
  }
  doFetch();
  fetchTimer=setInterval(doFetch,FETCH_INT*1000);
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
if(sessionStorage.getItem('gex_auth')==='1'&&window.location.protocol!=='file:')startFetch();
</script>
</body></html>
